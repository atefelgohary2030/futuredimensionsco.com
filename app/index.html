<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Future Dimensions</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --bg0:#060b13;
      --bg1:#071222;
      --panel:rgba(18,28,44,0.55);
      --panel2:rgba(14,22,36,0.72);
      --stroke:rgba(255,255,255,0.08);
      --stroke2:rgba(255,255,255,0.12);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.62);
      --gold:#d6b35b;
      --gold2:#9b7a2a;
      --red:#ff5a6a;
      --green:#39d98a;
      --shadow:0 20px 60px rgba(0,0,0,0.55);
      --r:22px;
      --r2:16px;
      --pad:18px;
      --pad2:14px;
      --max:1180px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Arabic", "Noto Sans", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(214,179,91,0.18), transparent 60%),
        radial-gradient(1200px 700px at 80% 10%, rgba(80,140,255,0.16), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 16px 96px}
    .topbar{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(6,11,19,0.85), rgba(6,11,19,0.45));
      border-bottom:1px solid var(--stroke);
    }
    .topbar-inner{
      max-width:var(--max); margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:240px}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(214,179,91,0.85), rgba(155,122,42,0.18) 56%, rgba(0,0,0,0) 58%),
                  linear-gradient(135deg, rgba(214,179,91,0.35), rgba(6,11,19,0.2));
      border:1px solid rgba(214,179,91,0.35);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
      display:grid; place-items:center;
      position:relative;
    }
    .logo:after{
      content:"FD";
      font-weight:900;
      letter-spacing:0.8px;
      color:rgba(255,255,255,0.92);
      font-size:14px;
      text-shadow:0 10px 22px rgba(0,0,0,0.5);
    }
    .brand h1{font-size:15px; margin:0; line-height:1.1}
    .brand small{display:block; margin-top:3px; color:var(--muted); font-size:11px}
    .actions{display:flex; align-items:center; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px; border-radius:999px;
      background: rgba(255,255,255,0.04);
      border:1px solid var(--stroke);
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{border-color:rgba(214,179,91,0.35)}
    .pill .dot{width:8px; height:8px; border-radius:50%}
    .dot.off{background:rgba(255,255,255,0.25)}
    .dot.on{background:rgba(57,217,138,0.95)}
    .iconbtn{
      width:40px; height:40px; border-radius:999px;
      border:1px solid rgba(214,179,91,0.28);
      background: rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.9);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .iconbtn:hover{border-color:rgba(214,179,91,0.55)}
    .main{padding-top:18px}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.1fr 0.9fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:16px 18px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
    }
    .panel-title{
      margin:0;
      font-size:16px;
      letter-spacing:0.2px;
    }
    .panel-sub{margin:4px 0 0; color:var(--muted); font-size:12px}
    .panel-body{padding:16px 18px}
    .cards{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 560px){
      .cards{grid-template-columns:1fr}
    }
    .card{
      padding:14px;
      border-radius:var(--r2);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      cursor:pointer;
      transition: transform 120ms ease, border-color 120ms ease;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      min-height:64px;
    }
    .card:hover{transform: translateY(-1px); border-color:rgba(214,179,91,0.35)}
    .card strong{display:block; font-size:14px}
    .card span{display:block; color:var(--muted); font-size:12px; margin-top:3px}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(214,179,91,0.35);
      color:rgba(214,179,91,0.95);
      font-size:12px;
      background: rgba(214,179,91,0.08);
      white-space:nowrap;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(214,179,91,0.12);
      border:1px solid rgba(214,179,91,0.35);
      color:rgba(255,255,255,0.92);
      cursor:pointer;
      min-width:120px;
      user-select:none;
    }
    .btn:hover{background: rgba(214,179,91,0.16)}
    .btn.secondary{
      background: rgba(255,255,255,0.03);
      border-color: var(--stroke2);
      min-width:auto;
    }
    .btn.danger{
      background: rgba(255,90,106,0.12);
      border-color: rgba(255,90,106,0.35);
    }
    .btn.ok{
      background: rgba(57,217,138,0.10);
      border-color: rgba(57,217,138,0.35);
    }
    .input, textarea, select{
      width:100%;
      background: rgba(255,255,255,0.03);
      border:1px solid var(--stroke2);
      border-radius:14px;
      padding:11px 12px;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .field{display:grid; gap:7px; margin-bottom:12px}
    .label{font-size:12px; color:var(--muted)}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 560px){ .split{grid-template-columns:1fr} }
    .list{display:grid; gap:10px}
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.02);
      border-radius: var(--r2);
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .item .meta{min-width:0}
    .item .meta b{display:block; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .item .meta small{display:block; color:var(--muted); margin-top:4px; font-size:12px}
    .item .ops{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .toast{
      position:fixed; top:86px; left:50%; transform:translateX(-50%);
      width:min(720px, calc(100% - 24px));
      z-index:90;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,90,106,0.35);
      background: rgba(255,90,106,0.10);
      color: rgba(255,255,255,0.95);
      box-shadow: var(--shadow);
      display:none;
    }
    .toast.ok{
      border-color: rgba(57,217,138,0.35);
      background: rgba(57,217,138,0.10);
    }
    .bottomnav{
      position:fixed; bottom:0; left:0; right:0; z-index:40;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(6,11,19,0.0), rgba(6,11,19,0.75) 38%, rgba(6,11,19,0.88));
      border-top:1px solid var(--stroke);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabs{
      max-width:var(--max); margin:0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    .tab{
      padding:12px 10px;
      border-radius:16px;
      background: rgba(255,255,255,0.03);
      border:1px solid var(--stroke);
      text-align:center;
      cursor:pointer;
      color: rgba(255,255,255,0.85);
      user-select:none;
    }
    .tab.active{
      border-color: rgba(214,179,91,0.42);
      background: rgba(214,179,91,0.10);
      color: rgba(255,255,255,0.95);
    }
    .modal-back{
      position:fixed; inset:0; z-index:70;
      background: rgba(0,0,0,0.55);
      display:none;
      padding:18px;
    }
    .modal{
      max-width: 720px;
      margin: 60px auto;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(10,16,26,0.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal-head b{font-size:14px}
    .modal-body{padding:14px 16px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
    .hint{color:var(--muted); font-size:12px; line-height:1.45}
    .hr{height:1px; background: var(--stroke); margin:12px 0}
    .hide{display:none !important}
    .rtl{direction:rtl}
    .ltr{direction:ltr}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" role="banner">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Future Dimensions</h1>
          <small>Consulting &amp; Business Solutions</small>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="connPill" title="Connection">
          <span class="dot off" id="connDot"></span>
          <span id="connText" style="font-size:12px; color:var(--muted)">Offline</span>
        </div>
        <button class="iconbtn" id="langBtn" title="Language">EN</button>
        <button class="iconbtn" id="settingsBtn" title="Settings">âš™ï¸</button>
        <button class="iconbtn" id="userBtn" title="Account">ğŸ‘¤</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="main">
      <div class="grid">
        <div class="panel" id="panelMain">
          <div class="panel-head">
            <div>
              <p class="panel-title" id="pageTitle">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
              <p class="panel-sub" id="pageSub">Ù„Ùˆ Ø¸Ù‡Ø±Øª Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ØºØ§Ù„Ø¨Ø§ Ø§Ù„Ø³Ø¨Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Supabase Ø£Ùˆ Ø³ÙŠØ§Ø³Ø§Øª RLS</p>
            </div>
            <div class="row">
              <button class="btn secondary" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div class="panel-body" id="pageBody"></div>
        </div>

        <div class="panel" id="panelSide">
          <div class="panel-head">
            <div>
              <p class="panel-title" id="sideTitle">Ø§Ù„Ø­Ø§Ù„Ø©</p>
              <p class="panel-sub" id="sideSub">Ø§ØªØµØ§Ù„ØŒ Ø¬Ù„Ø³Ø©ØŒ ÙˆØ¬Ø¯Ø§ÙˆÙ„</p>
            </div>
            <div class="row">
              <button class="btn secondary" id="testBtn">Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
          </div>
          <div class="panel-body" id="sideBody"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottomnav">
    <div class="tabs">
      <div class="tab active" data-page="home" id="tabHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="tab" data-page="invoices" id="tabInvoices">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
      <div class="tab" data-page="documents" id="tabDocuments">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
      <div class="tab" data-page="support" id="tabSupport">Ø§Ù„Ø¯Ø¹Ù…</div>
      <div class="tab" data-page="meetings" id="tabMeetings">Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</div>
    </div>
  </div>

  <div class="modal-back" id="settingsModal">
    <div class="modal">
      <div class="modal-head">
        <b id="settingsTitle">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</b>
        <button class="btn secondary" id="settingsClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="label">Supabase URL</div>
          <input class="input ltr" id="sbUrl" placeholder="https://xxxx.supabase.co">
        </div>
        <div class="field">
          <div class="label">Anon Key</div>
          <textarea class="input ltr mono" id="sbKey" placeholder="eyJ..."></textarea>
        </div>
        <div class="row">
          <button class="btn ok" id="saveCfgBtn">Ø­ÙØ¸</button>
          <button class="btn secondary" id="clearCfgBtn">Ù…Ø³Ø­</button>
          <div class="hint" id="cfgHint">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-back" id="authModal">
    <div class="modal">
      <div class="modal-head">
        <b id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</b>
        <button class="btn secondary" id="authClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="label" id="emailLbl">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
          <input class="input ltr" id="authEmail" placeholder="name@email.com">
        </div>
        <div class="field">
          <div class="label" id="passLbl">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
          <input class="input ltr" id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="row">
          <button class="btn ok" id="signInBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn secondary" id="signUpBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <button class="btn secondary" id="magicBtn">Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„</button>
          <button class="btn danger hide" id="signOutBtn">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div class="hint" id="authHint" style="margin-top:10px">
          Ù„Ùˆ Ù…ÙØ¹Ù„ Ø³ÙŠØ§Ø³Ø§Øª RLS Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        </div>
      </div>
    </div>
  </div>

  <div class="modal-back" id="viewModal">
    <div class="modal">
      <div class="modal-head">
        <b id="viewTitle">ØªÙØ§ØµÙŠÙ„</b>
        <button class="btn secondary" id="viewClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="hint mono" id="viewBody" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const $ = (id) => document.getElementById(id)

    const state = {
      page: "home",
      lang: localStorage.getItem("fd_lang") || "ar",
      cfg: null,
      warnedNoCfg: false,
      supabase: null,
      session: null,
      user: null,
      columns: {},
      buckets: {
        documents: "Documents",
        invoices: "Invoices"
      }
    }

    const txt = (ar, en) => state.lang === "ar" ? ar : en

    const showToast = (msg, ok=false) => {
      const el = $("toast")
      if (!el) return
      el.textContent = msg
      el.classList.toggle("ok", ok)
      el.style.display = "block"
      clearTimeout(showToast._t)
      showToast._t = setTimeout(() => { el.style.display = "none" }, 4200)
    }

    const setConn = (on, label) => {
      const dot = $("connDot")
      const t = $("connText")
      if (dot) {
        dot.classList.toggle("on", !!on)
        dot.classList.toggle("off", !on)
      }
      if (t) t.textContent = label || (on ? "Online" : "Offline")
    }

    const openModal = (id) => { const el = $(id); if (el) el.style.display = "block" }
    const closeModal = (id) => { const el = $(id); if (el) el.style.display = "none" }

    const applyLang = () => {
      document.documentElement.lang = state.lang
      document.documentElement.dir = state.lang === "ar" ? "rtl" : "ltr"

      $("langBtn").textContent = state.lang === "ar" ? "EN" : "Ø¹Ø±Ø¨ÙŠ"

      $("tabHome").textContent = txt("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©","Home")
      $("tabInvoices").textContent = txt("Ø§Ù„ÙÙˆØ§ØªÙŠØ±","Invoices")
      $("tabDocuments").textContent = txt("Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª","Documents")
      $("tabSupport").textContent = txt("Ø§Ù„Ø¯Ø¹Ù…","Support")
      $("tabMeetings").textContent = txt("Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª","Meetings")

      $("refreshBtn").textContent = txt("ØªØ­Ø¯ÙŠØ«","Refresh")
      $("testBtn").textContent = txt("Ø§Ø®ØªØ¨Ø§Ø±","Test")

      $("settingsTitle").textContent = txt("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","Settings")
      $("settingsClose").textContent = txt("Ø¥ØºÙ„Ø§Ù‚","Close")
      $("saveCfgBtn").textContent = txt("Ø­ÙØ¸","Save")
      $("clearCfgBtn").textContent = txt("Ù…Ø³Ø­","Clear")
      $("cfgHint").textContent = txt("Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·","Saved in this browser only")

      $("authTitle").textContent = txt("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","Sign in")
      $("authClose").textContent = txt("Ø¥ØºÙ„Ø§Ù‚","Close")
      $("emailLbl").textContent = txt("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ","Email")
      $("passLbl").textContent = txt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±","Password")
      $("signInBtn").textContent = txt("Ø¯Ø®ÙˆÙ„","Sign in")
      $("signUpBtn").textContent = txt("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨","Sign up")
      $("magicBtn").textContent = txt("Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„","Magic link")
      $("signOutBtn").textContent = txt("Ø®Ø±ÙˆØ¬","Sign out")
      $("authHint").textContent = txt("Ù„Ùˆ Ù…ÙØ¹Ù„ Ø³ÙŠØ§Ø³Ø§Øª RLS Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„","If RLS is enabled you must be signed in")

      render()
    }

    const loadCfg = () => {
      const url = localStorage.getItem("fd_supabaseUrl") || ""
      const key = localStorage.getItem("fd_anonKey") || ""
      if (url && key) state.cfg = { url, key }
      else state.cfg = null
    }

    const saveCfg = (url, key) => {
      localStorage.setItem("fd_supabaseUrl", (url || "").trim())
      localStorage.setItem("fd_anonKey", (key || "").trim())
      loadCfg()
    }

    
  const loadCfgFromUrl = () => {
    try {
      const u = new URL(location.href)
      const sp = u.searchParams
      const supabaseUrl = (sp.get("supabaseUrl") || sp.get("sbUrl") || sp.get("SUPABASE_URL") || "").trim()
      const anonKey = (sp.get("anonKey") || sp.get("sbKey") || sp.get("SUPABASE_ANON_KEY") || "").trim()
      if (!supabaseUrl && !anonKey) return null
      return { supabaseUrl, anonKey }
    } catch {
      return null
    }
  }

  const applyCfgFromUrl = () => {
    const c = loadCfgFromUrl()
    if (!c || !c.supabaseUrl || !c.anonKey) return false
    try {
      localStorage.setItem("fd_supabaseUrl", c.supabaseUrl)
      localStorage.setItem("fd_anonKey", c.anonKey)
    } catch {}
    state.cfg = c
    // remove secrets from URL
    try {
      const u = new URL(location.href)
      ;["supabaseUrl","sbUrl","SUPABASE_URL","anonKey","sbKey","SUPABASE_ANON_KEY"].forEach((k) => u.searchParams.delete(k))
      history.replaceState({}, "", u.pathname + u.search + u.hash)
    } catch {}
    return true
  }
const clearCfg = () => {
      localStorage.removeItem("fd_supabaseUrl")
      localStorage.removeItem("fd_anonKey")
      state.cfg = null
      state.supabase = null
      state.session = null
      state.user = null
      state.columns = {}
      setConn(false, txt("ØºÙŠØ± Ù…ØªØµÙ„","Offline"))
      render()
    }

    const initSupabase = async () => {
      try{
        if (!state.cfg || !state.cfg.url || !state.cfg.key) return false
        if (!window.supabase || !window.supabase.createClient) {
          showToast(txt("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase","Supabase library failed to load"))
          return false
        }

        state.supabase = window.supabase.createClient(state.cfg.url, state.cfg.key, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true
          }
        })

        const { data } = await state.supabase.auth.getSession()
        state.session = data ? data.session : null
        state.user = state.session ? state.session.user : null

        state.supabase.auth.onAuthStateChange((_event, sess) => {
          state.session = sess
          state.user = sess ? sess.user : null
          renderSide()
        })

        setConn(true, txt("Ù…ØªØµÙ„","Online"))
        return true
      }catch(err){
        console.error(err)
        setConn(false, txt("ØºÙŠØ± Ù…ØªØµÙ„","Offline"))
        showToast((err && err.message) ? err.message : txt("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯","Config error"))
        return false
      }
    }

    const safeDate = (v) => {
      try{
        if (!v) return "-"
        const d = new Date(v)
        if (isNaN(d.getTime())) return String(v)
        return d.toLocaleString(state.lang === "ar" ? "ar-EG" : "en-US")
      }catch{
        return String(v || "-")
      }
    }

    const shortId = (id) => id ? String(id).slice(0,8) : "-"

    const ensureColumns = async (table, fallback) => {
      if (state.columns[table]) return state.columns[table]
      if (!state.supabase) {
        state.columns[table] = fallback
        return fallback
      }
      try{
        const { data, error } = await state.supabase.from(table).select("*").limit(1)
        if (error) {
          state.columns[table] = fallback
          return fallback
        }
        if (data && data.length) {
          state.columns[table] = Object.keys(data[0] || {})
          return state.columns[table]
        }
        state.columns[table] = fallback
        return fallback
      }catch{
        state.columns[table] = fallback
        return fallback
      }
    }

    const pick = (cols, obj) => {
      const out = {}
      for (const k in obj) {
        if (cols.includes(k)) out[k] = obj[k]
      }
      return out
    }

    const mustCfg = async () => {
      loadCfg()
      if (!state.cfg) {
        openModal("settingsModal")
        showToast(txt("Ù„Ø§Ø²Ù… ØªØ­Ø· Supabase URL Ùˆ Anon Key","Supabase URL and Anon Key are required"))
        return false
      }
      if (!state.supabase) {
        const ok = await initSupabase()
        if (!ok) return false
      }
      return true
    }

    const renderSide = () => {
      const el = $("sideBody")
      if (!el) return

      const email = state.user && state.user.email ? state.user.email : txt("ØºÙŠØ± Ù…Ø³Ø¬Ù„","Not signed in")
      const cfgOk = !!(state.cfg && state.cfg.url && state.cfg.key)
      const conn = state.supabase ? txt("Ù…ØªØµÙ„","Online") : txt("ØºÙŠØ± Ù…ØªØµÙ„","Offline")

      el.innerHTML = `
        <div class="field">
          <div class="label">${txt("Ø§Ù„Ø§ØªØµØ§Ù„","Connection")}</div>
          <div class="input" style="display:flex; justify-content:space-between; gap:10px">
            <span>${conn}</span>
            <span class="badge">${cfgOk ? txt("Ø¬Ø§Ù‡Ø²","Ready") : txt("Ù†Ø§Ù‚Øµ","Missing")}</span>
          </div>
        </div>
        <div class="field">
          <div class="label">${txt("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…","User")}</div>
          <div class="input ltr" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${email}</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          ${txt("Ù„Ùˆ ØµÙØ­Ø§ØªÙƒ Ø¨ØªØ·Ù„Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù† Ø£Ø¹Ù…Ø¯Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¯Ù‡ Ù…Ø¹Ù†Ø§Ù‡ Ø¥Ù† Ø¬Ø¯ÙˆÙ„Ùƒ Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŒ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§","If you see errors about missing columns, your table schema differs, the app tries to adapt automatically")}
        </div>
      `
    }

    const setActiveTab = (page) => {
      state.page = page
      for (const el of document.querySelectorAll(".tab")) {
        el.classList.toggle("active", el.dataset.page === page)
      }
      render()
    }

    const renderHome = () => {
      $("pageTitle").textContent = txt("Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©","Home")
      $("pageSub").textContent = txt("ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø³Ø±ÙŠØ¹Ø©","App dashboard and quick actions")

      const cfgOk = !!(state.cfg && state.cfg.url && state.cfg.key)
      const signed = !!state.user
      const warn = !cfgOk ? txt("Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ Supabase URL Ùˆ Anon Key Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","Add Supabase URL and Anon Key from Settings") :
                   !signed ? txt("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ø´Ø§Ù† RLS ØªØ´ØªØºÙ„ ØµØ­","Sign in so RLS works") :
                   txt("Ø¬Ø§Ù‡Ø²","Ready")

      return `
        <div class="cards">
          <div class="card" data-go="documents">
            <div>
              <strong>${txt("Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª","Documents")}</strong>
              <span>${txt("Ø±ÙØ¹ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª","Upload and download files")}</span>
            </div>
            <div class="badge">ğŸ“</div>
          </div>
          <div class="card" data-go="invoices">
            <div>
              <strong>${txt("Ø§Ù„ÙÙˆØ§ØªÙŠØ±","Invoices")}</strong>
              <span>${txt("Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±","Manage invoice files")}</span>
            </div>
            <div class="badge">ğŸ§¾</div>
          </div>
          <div class="card" data-go="support">
            <div>
              <strong>${txt("Ø§Ù„Ø¯Ø¹Ù…","Support")}</strong>
              <span>${txt("Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±","Create and track tickets")}</span>
            </div>
            <div class="badge">ğŸ«</div>
          </div>
          <div class="card" data-go="meetings">
            <div>
              <strong>${txt("Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª","Meetings")}</strong>
              <span>${txt("Ø·Ù„Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø©","Request meetings")}</span>
            </div>
            <div class="badge">ğŸ“…</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="panel" style="background:var(--panel2); border-radius:var(--r2); border:1px solid var(--stroke)">
          <div class="panel-body" style="padding:14px">
            <div class="row" style="justify-content:space-between">
              <div>
                <b>${txt("Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„","Run status")}</b>
                <div class="hint" style="margin-top:6px">${warn}</div>
              </div>
              <div class="row">
                <button class="btn secondary" id="openSettingsInline">${txt("ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","Open settings")}</button>
                <button class="btn secondary" id="openAuthInline">${txt("Ø§Ù„Ø­Ø³Ø§Ø¨","Account")}</button>
              </div>
            </div>
          </div>
        </div>
      `
    }

    const renderDocuments = async () => {
      $("pageTitle").textContent = txt("Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª","Documents")
      $("pageSub").textContent = txt("Ø±ÙØ¹ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡","Upload and manage client documents")

      const ok = await mustCfg()
      if (!ok) return renderNeedSetup()

      const cols = await ensureColumns("documents", ["id","user_id","type","name_en","name_ar","storage_path","created_at"])
      const nameKey = state.lang === "ar" ? (cols.includes("name_ar") ? "name_ar" : "name_en") : (cols.includes("name_en") ? "name_en" : "name_ar")

      let listHtml = `<div class="hint">${txt("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª","No documents yet")}</div>`
      try{
        const { data, error } = await state.supabase.from("documents").select("*").order("created_at", { ascending:false }).limit(50)
        if (error) throw error
        if (data && data.length) {
          listHtml = data.map(row => {
            const title = row[nameKey] || row.name_en || row.name_ar || row.type || "Document"
            const when = safeDate(row.created_at)
            const id = row.id || ""
            return `
              <div class="item">
                <div class="meta">
                  <b>${escapeHtml(title)}</b>
                  <small>${txt("ØªØ§Ø±ÙŠØ®","Date")}: ${escapeHtml(when)} Â· ${txt("Ø±Ù‚Ù…","ID")}: ${escapeHtml(shortId(id))}</small>
                </div>
                <div class="ops">
                  <button class="btn secondary" data-doc-open="${escapeAttr(id)}">${txt("ÙØªØ­","Open")}</button>
                  <button class="btn" data-doc-dl="${escapeAttr(id)}">${txt("ØªØ­Ù…ÙŠÙ„","Download")}</button>
                </div>
              </div>
            `
          }).join("")
        }
      }catch(err){
        listHtml = `<div class="hint">${txt("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©","Could not load list")}: ${escapeHtml(err.message || String(err))}</div>`
      }

      const typeOpts = `
        <option value="report">${txt("ØªÙ‚Ø±ÙŠØ±","Report")}</option>
        <option value="contract">${txt("Ø¹Ù‚Ø¯","Contract")}</option>
        <option value="other">${txt("Ø£Ø®Ø±Ù‰","Other")}</option>
      `
      return `
        <div class="split">
          <div>
            <div class="field">
              <div class="label">${txt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","Title")}</div>
              <input class="input" id="docTitle" placeholder="${txt("Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ±","Example: Report")}">
            </div>
          </div>
          <div>
            <div class="field">
              <div class="label">${txt("Ø§Ù„Ù†ÙˆØ¹","Type")}</div>
              <select id="docType">${typeOpts}</select>
            </div>
          </div>
        </div>
        <div class="field">
          <div class="label">${txt("Ø§Ø®ØªØ± Ù…Ù„Ù","Choose file")}</div>
          <input class="input" id="docFile" type="file">
        </div>
        <div class="row">
          <button class="btn ok" id="docUploadBtn">${txt("Ø±ÙØ¹","Upload")}</button>
          <button class="btn secondary" id="docReloadBtn">${txt("ØªØ­Ø¯ÙŠØ«","Refresh")}</button>
        </div>

        <div class="hr"></div>
        <div class="list">${listHtml}</div>
      `
    }

    const renderInvoices = async () => {
      $("pageTitle").textContent = txt("Ø§Ù„ÙÙˆØ§ØªÙŠØ±","Invoices")
      $("pageSub").textContent = txt("Ø±ÙØ¹ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±","Upload and manage invoice files")

      const ok = await mustCfg()
      if (!ok) return renderNeedSetup()

      const cols = await ensureColumns("invoices", ["id","user_id","name","name_en","name_ar","storage_path","created_at","status","amount"])
      const nameKey = cols.includes("name") ? "name" : (state.lang === "ar" ? (cols.includes("name_ar") ? "name_ar" : "name_en") : (cols.includes("name_en") ? "name_en" : "name_ar"))

      let listHtml = `<div class="hint">${txt("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±","No invoices yet")}</div>`
      try{
        const { data, error } = await state.supabase.from("invoices").select("*").order("created_at", { ascending:false }).limit(50)
        if (error) throw error
        if (data && data.length) {
          listHtml = data.map(row => {
            const title = row[nameKey] || "Invoice"
            const when = safeDate(row.created_at)
            const status = row.status || "-"
            const id = row.id || ""
            return `
              <div class="item">
                <div class="meta">
                  <b>${escapeHtml(title)}</b>
                  <small>${txt("Ø­Ø§Ù„Ø©","Status")}: ${escapeHtml(status)} Â· ${txt("ØªØ§Ø±ÙŠØ®","Date")}: ${escapeHtml(when)}</small>
                </div>
                <div class="ops">
                  <button class="btn secondary" data-inv-open="${escapeAttr(id)}">${txt("ÙØªØ­","Open")}</button>
                  <button class="btn" data-inv-dl="${escapeAttr(id)}">${txt("ØªØ­Ù…ÙŠÙ„","Download")}</button>
                </div>
              </div>
            `
          }).join("")
        }
      }catch(err){
        listHtml = `<div class="hint">${txt("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©","Could not load list")}: ${escapeHtml(err.message || String(err))}</div>`
      }

      return `
        <div class="field">
          <div class="label">${txt("Ø§Ø³Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©","Invoice name")}</div>
          <input class="input" id="invTitle" placeholder="${txt("Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© ÙŠÙ†Ø§ÙŠØ±","Example: January invoice")}">
        </div>
        <div class="field">
          <div class="label">${txt("Ø§Ø®ØªØ± Ù…Ù„Ù","Choose file")}</div>
          <input class="input" id="invFile" type="file">
        </div>
        <div class="row">
          <button class="btn ok" id="invUploadBtn">${txt("Ø±ÙØ¹","Upload")}</button>
          <button class="btn secondary" id="invReloadBtn">${txt("ØªØ­Ø¯ÙŠØ«","Refresh")}</button>
        </div>

        <div class="hr"></div>
        <div class="list">${listHtml}</div>
      `
    }

    const renderSupport = async () => {
      $("pageTitle").textContent = txt("Ø§Ù„Ø¯Ø¹Ù…","Support")
      $("pageSub").textContent = txt("Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯Ø¹Ù…","Create and track support tickets")

      const ok = await mustCfg()
      if (!ok) return renderNeedSetup()

      const cols = await ensureColumns("tickets", ["id","subject_en","subject_ar","category","details","status","created_at","message"])
      const subjKey = state.lang === "ar" ? (cols.includes("subject_ar") ? "subject_ar" : "subject_en") : (cols.includes("subject_en") ? "subject_en" : "subject_ar")
      const detailsKey = cols.includes("details") ? "details" : (cols.includes("message") ? "message" : null)

      let listHtml = `<div class="hint">${txt("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ±","No tickets yet")}</div>`
      try{
        const { data, error } = await state.supabase.from("tickets").select("*").order("created_at", { ascending:false }).limit(50)
        if (error) throw error
        if (data && data.length) {
          listHtml = data.map(row => {
            const title = row[subjKey] || row.subject_en || row.subject_ar || "Ticket"
            const when = safeDate(row.created_at)
            const st = row.status || "open"
            const id = row.id || ""
            return `
              <div class="item">
                <div class="meta">
                  <b>${escapeHtml(title)}</b>
                  <small>${txt("Ø§Ù„Ø­Ø§Ù„Ø©","Status")}: ${escapeHtml(st)} Â· ${escapeHtml(when)} Â· ${txt("Ø±Ù‚Ù…","ID")}: ${escapeHtml(shortId(id))}</small>
                </div>
                <div class="ops">
                  <button class="btn secondary" data-ticket-view="${escapeAttr(id)}">${txt("Ø¹Ø±Ø¶","View")}</button>
                </div>
              </div>
            `
          }).join("")
        }
      }catch(err){
        listHtml = `<div class="hint">${txt("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©","Could not load list")}: ${escapeHtml(err.message || String(err))}</div>`
      }

      return `
        <div class="split">
          <div class="field">
            <div class="label">${txt("Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Subject")}</div>
            <input class="input" id="ticketSubject" placeholder="${txt("Ù…Ø«Ø§Ù„: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„","Example: Login issue")}">
          </div>
          <div class="field">
            <div class="label">${txt("Ø§Ù„ØªØµÙ†ÙŠÙ","Category")}</div>
            <select id="ticketCat">
              <option value="EMPTY">${txt("Ø¹Ø§Ù…","General")}</option>
              <option value="TECH">${txt("ØªÙ‚Ù†ÙŠ","Technical")}</option>
              <option value="BILL">${txt("ÙÙˆØ§ØªÙŠØ±","Billing")}</option>
            </select>
          </div>
        </div>
        <div class="field">
          <div class="label">${txt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Details")}</div>
          <textarea class="input" id="ticketDetails" placeholder="${txt("Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§","Write details here")}"></textarea>
        </div>
        <div class="row">
          <button class="btn ok" id="ticketSendBtn">${txt("Ø¥Ø±Ø³Ø§Ù„","Send")}</button>
          <button class="btn secondary" id="ticketReloadBtn">${txt("ØªØ­Ø¯ÙŠØ«","Refresh")}</button>
        </div>

        <div class="hr"></div>
        <div class="list">${listHtml}</div>
      `
    }

    const renderMeetings = async () => {
      $("pageTitle").textContent = txt("Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª","Meetings")
      $("pageSub").textContent = txt("Ø·Ù„Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª","Request meetings and track status")

      const ok = await mustCfg()
      if (!ok) return renderNeedSetup()

      const cols = await ensureColumns("meetings", ["id","user_id","title","meeting_date","meeting_time","notes","status","created_at"])
      const hasTime = cols.includes("meeting_time")
      const hasDate = cols.includes("meeting_date")

      let listHtml = `<div class="hint">${txt("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª","No meetings yet")}</div>`
      try{
        const { data, error } = await state.supabase.from("meetings").select("*").order("created_at", { ascending:false }).limit(50)
        if (error) throw error
        if (data && data.length) {
          listHtml = data.map(row => {
            const title = row.title || "Meeting"
            const when = safeDate(row.created_at)
            const d = row.meeting_date || "-"
            const tm = row.meeting_time || "-"
            const st = row.status || "open"
            const id = row.id || ""
            return `
              <div class="item">
                <div class="meta">
                  <b>${escapeHtml(title)}</b>
                  <small>${txt("ØªØ§Ø±ÙŠØ®","Date")}: ${escapeHtml(d)} Â· ${txt("ÙˆÙ‚Øª","Time")}: ${escapeHtml(tm)} Â· ${txt("Ø­Ø§Ù„Ø©","Status")}: ${escapeHtml(st)}</small>
                </div>
                <div class="ops">
                  <button class="btn secondary" data-meet-view="${escapeAttr(id)}">${txt("Ø¹Ø±Ø¶","View")}</button>
                </div>
              </div>
            `
          }).join("")
        }
      }catch(err){
        listHtml = `<div class="hint">${txt("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©","Could not load list")}: ${escapeHtml(err.message || String(err))}</div>`
      }

      return `
        <div class="split">
          <div class="field">
            <div class="label">${txt("Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Title")}</div>
            <input class="input" id="meetTitle" placeholder="${txt("Ù…Ø«Ø§Ù„: Ø§Ø¬ØªÙ…Ø§Ø¹ Ù…ØªØ§Ø¨Ø¹Ø©","Example: Follow up meeting")}">
          </div>
          <div class="field">
            <div class="label">${txt("Ø§Ù„ØªØ§Ø±ÙŠØ®","Date")}</div>
            <input class="input ltr" id="meetDate" type="date" ${hasDate ? "required" : ""}>
          </div>
        </div>
        <div class="split">
          <div class="field">
            <div class="label">${txt("Ø§Ù„ÙˆÙ‚Øª","Time")}</div>
            <input class="input ltr" id="meetTime" type="time" ${hasTime ? "required" : ""}>
          </div>
          <div class="field">
            <div class="label">${txt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Notes")}</div>
            <input class="input" id="meetNotes" placeholder="${txt("Ø§Ø®ØªÙŠØ§Ø±ÙŠ","Optional")}">
          </div>
        </div>
        <div class="row">
          <button class="btn ok" id="meetSendBtn">${txt("Ø¥Ø±Ø³Ø§Ù„","Send")}</button>
          <button class="btn secondary" id="meetReloadBtn">${txt("ØªØ­Ø¯ÙŠØ«","Refresh")}</button>
        </div>

        <div class="hr"></div>
        <div class="list">${listHtml}</div>
      `
    }

    const renderNeedSetup = () => `
      <div class="panel" style="background:var(--panel2); border-radius:var(--r2); border:1px solid var(--stroke)">
        <div class="panel-body" style="padding:16px">
          <b>${txt("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚","App is not ready")}</b>
          <div class="hint" style="margin-top:8px">
            ${txt("Ø§Ø¶ØºØ· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¶Ø¹ Supabase URL Ùˆ Anon Key Ø«Ù… Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ","Open Settings and paste Supabase URL and Anon Key then try again")}
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn ok" id="needSettingsBtn">${txt("ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª","Open settings")}</button>
            <button class="btn secondary" id="needAuthBtn">${txt("Ø§Ù„Ø­Ø³Ø§Ø¨","Account")}</button>
          </div>
        </div>
      </div>
    `

    const escapeHtml = (s) => String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    const escapeAttr = (s) => escapeHtml(s).replaceAll('"',"&quot;")

    const render = async () => {
      renderSide()

      const body = $("pageBody")
      if (!body) return

      if (state.page === "home") body.innerHTML = renderHome()
      if (state.page === "documents") body.innerHTML = await renderDocuments()
      if (state.page === "invoices") body.innerHTML = await renderInvoices()
      if (state.page === "support") body.innerHTML = await renderSupport()
      if (state.page === "meetings") body.innerHTML = await renderMeetings()

      bindPageEvents()
    }

    const bindPageEvents = () => {
      for (const c of document.querySelectorAll("[data-go]")) {
        c.onclick = () => setActiveTab(c.getAttribute("data-go"))
      }

      const openSettingsInline = $("openSettingsInline")
      if (openSettingsInline) openSettingsInline.onclick = () => openModal("settingsModal")
      const openAuthInline = $("openAuthInline")
      if (openAuthInline) openAuthInline.onclick = () => openModal("authModal")

      const needSettingsBtn = $("needSettingsBtn")
      if (needSettingsBtn) needSettingsBtn.onclick = () => openModal("settingsModal")
      const needAuthBtn = $("needAuthBtn")
      if (needAuthBtn) needAuthBtn.onclick = () => openModal("authModal")

      const docReload = $("docReloadBtn")
      if (docReload) docReload.onclick = () => render()
      const invReload = $("invReloadBtn")
      if (invReload) invReload.onclick = () => render()
      const ticketReload = $("ticketReloadBtn")
      if (ticketReload) ticketReload.onclick = () => render()
      const meetReload = $("meetReloadBtn")
      if (meetReload) meetReload.onclick = () => render()

      const docUploadBtn = $("docUploadBtn")
      if (docUploadBtn) docUploadBtn.onclick = () => onUploadDocument()
      const invUploadBtn = $("invUploadBtn")
      if (invUploadBtn) invUploadBtn.onclick = () => onUploadInvoice()
      const ticketSendBtn = $("ticketSendBtn")
      if (ticketSendBtn) ticketSendBtn.onclick = () => onCreateTicket()
      const meetSendBtn = $("meetSendBtn")
      if (meetSendBtn) meetSendBtn.onclick = () => onCreateMeeting()

      for (const b of document.querySelectorAll("[data-doc-dl]")) {
        b.onclick = () => onDownloadById("documents", b.getAttribute("data-doc-dl"), state.buckets.documents)
      }
      for (const b of document.querySelectorAll("[data-inv-dl]")) {
        b.onclick = () => onDownloadById("invoices", b.getAttribute("data-inv-dl"), state.buckets.invoices)
      }
      for (const b of document.querySelectorAll("[data-ticket-view]")) {
        b.onclick = () => onViewById("tickets", b.getAttribute("data-ticket-view"))
      }
      for (const b of document.querySelectorAll("[data-meet-view]")) {
        b.onclick = () => onViewById("meetings", b.getAttribute("data-meet-view"))
      }
      for (const b of document.querySelectorAll("[data-doc-open]")) {
        b.onclick = () => onViewById("documents", b.getAttribute("data-doc-open"))
      }
      for (const b of document.querySelectorAll("[data-inv-open]")) {
        b.onclick = () => onViewById("invoices", b.getAttribute("data-inv-open"))
      }
    }

    const requireSignedIn = () => {
      if (state.user) return true
      showToast(txt("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„","You must sign in"))
      openModal("authModal")
      return false
    }

    const onUploadDocument = async () => {
      const ok = await mustCfg()
      if (!ok) return
      if (!requireSignedIn()) return

      const fileEl = $("docFile")
      const titleEl = $("docTitle")
      const typeEl = $("docType")
      const file = fileEl && fileEl.files ? fileEl.files[0] : null

      if (!file) return showToast(txt("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù","Choose a file"))
      const title = (titleEl ? titleEl.value : "").trim() || file.name
      const type = typeEl ? typeEl.value : "report"

      try{
        const cols = await ensureColumns("documents", ["id","user_id","type","name_en","name_ar","storage_path","created_at"])
        const bucket = state.buckets.documents

        const userId = state.user.id
        const safeName = String(file.name || "file").replaceAll("..","").replaceAll("/","_")
        const path = `${userId}/${Date.now()}_${safeName}`

        const up = await state.supabase.storage.from(bucket).upload(path, file, { upsert:false })
        if (up.error) throw up.error

        const row = {
          user_id: userId,
          type,
          name_en: title,
          name_ar: title,
          storage_path: path
        }
        const payload = pick(cols, row)
        const ins = await state.supabase.from("documents").insert(payload).select("*").single()
        if (ins.error) throw ins.error

        showToast(txt("ØªÙ… Ø§Ù„Ø±ÙØ¹","Uploaded"), true)
        render()
      }catch(err){
        console.error(err)
        showToast(err.message || String(err))
      }
    }

    const onUploadInvoice = async () => {
      const ok = await mustCfg()
      if (!ok) return
      if (!requireSignedIn()) return

      const fileEl = $("invFile")
      const titleEl = $("invTitle")
      const file = fileEl && fileEl.files ? fileEl.files[0] : null

      if (!file) return showToast(txt("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù","Choose a file"))
      const title = (titleEl ? titleEl.value : "").trim() || file.name

      try{
        const cols = await ensureColumns("invoices", ["id","user_id","name","name_en","name_ar","storage_path","created_at","status","amount"])
        const bucket = state.buckets.invoices

        const userId = state.user.id
        const safeName = String(file.name || "file").replaceAll("..","").replaceAll("/","_")
        const path = `${userId}/${Date.now()}_${safeName}`

        const up = await state.supabase.storage.from(bucket).upload(path, file, { upsert:false })
        if (up.error) throw up.error

        const row = {
          user_id: userId,
          name: title,
          name_en: title,
          name_ar: title,
          storage_path: path,
          status: "new"
        }
        const payload = pick(cols, row)
        const ins = await state.supabase.from("invoices").insert(payload).select("*").single()
        if (ins.error) throw ins.error

        showToast(txt("ØªÙ… Ø§Ù„Ø±ÙØ¹","Uploaded"), true)
        render()
      }catch(err){
        console.error(err)
        showToast(err.message || String(err))
      }
    }

    const onCreateTicket = async () => {
      const ok = await mustCfg()
      if (!ok) return
      if (!requireSignedIn()) return

      const subj = ($("ticketSubject") ? $("ticketSubject").value : "").trim()
      const det = ($("ticketDetails") ? $("ticketDetails").value : "").trim()
      const cat = $("ticketCat") ? $("ticketCat").value : "EMPTY"
      if (!subj) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Enter subject"))
      if (!det) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„","Enter details"))

      try{
        const cols = await ensureColumns("tickets", ["id","subject_en","subject_ar","category","details","status","created_at","message","user_id"])

        const row = {
          user_id: state.user.id,
          subject_en: subj,
          subject_ar: subj,
          category: cat,
          details: det,
          message: det,
          status: "open"
        }
        const payload = pick(cols, row)
        const ins = await state.supabase.from("tickets").insert(payload).select("*").single()
        if (ins.error) throw ins.error

        showToast(txt("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„","Sent"), true)
        render()
      }catch(err){
        console.error(err)
        showToast(err.message || String(err))
      }
    }

    const onCreateMeeting = async () => {
      const ok = await mustCfg()
      if (!ok) return
      if (!requireSignedIn()) return

      const title = ($("meetTitle") ? $("meetTitle").value : "").trim()
      const date = ($("meetDate") ? $("meetDate").value : "").trim()
      const time = ($("meetTime") ? $("meetTime").value : "").trim()
      const notes = ($("meetNotes") ? $("meetNotes").value : "").trim()

      if (!title) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Enter title"))
      if (!date) return showToast(txt("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®","Choose date"))
      if (!time) return showToast(txt("Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª","Choose time"))

      try{
        const cols = await ensureColumns("meetings", ["id","user_id","title","meeting_date","meeting_time","notes","status","created_at"])

        const row = {
          user_id: state.user.id,
          title,
          meeting_date: date,
          meeting_time: time,
          notes,
          status: "open"
        }
        const payload = pick(cols, row)
        const ins = await state.supabase.from("meetings").insert(payload).select("*").single()
        if (ins.error) throw ins.error

        showToast(txt("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„","Sent"), true)
        render()
      }catch(err){
        console.error(err)
        showToast(err.message || String(err))
      }
    }

    const onViewById = async (table, id) => {
      const ok = await mustCfg()
      if (!ok) return

      try{
        const { data, error } = await state.supabase.from(table).select("*").eq("id", id).limit(1).single()
        if (error) throw error
        $("viewTitle").textContent = txt("ØªÙØ§ØµÙŠÙ„","Details")
        $("viewBody").textContent = JSON.stringify(data, null, 2)
        openModal("viewModal")
      }catch(err){
        showToast(err.message || String(err))
      }
    }

    const onDownloadById = async (table, id, bucket) => {
      const ok = await mustCfg()
      if (!ok) return
      if (!requireSignedIn()) return

      try{
        const cols = await ensureColumns(table, ["id","storage_path","name","name_en","name_ar"])
        const { data, error } = await state.supabase.from(table).select("*").eq("id", id).limit(1).single()
        if (error) throw error

        const path = data.storage_path || data.path || data.file_path
        if (!path) {
          showToast(txt("Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„","File path is missing in table"))
          return
        }

        const signed = await state.supabase.storage.from(bucket).createSignedUrl(path, 60)
        if (signed.error) throw signed.error

        const url = signed.data.signedUrl
        window.open(url, "_blank")
      }catch(err){
        console.error(err)
        showToast(err.message || String(err))
      }
    }

    const bindGlobal = () => {
      $("settingsBtn").onclick = () => openModal("settingsModal")
      $("settingsClose").onclick = () => closeModal("settingsModal")
      $("clearCfgBtn").onclick = () => {
        clearCfg()
        closeModal("settingsModal")
        showToast(txt("ØªÙ… Ø§Ù„Ù…Ø³Ø­","Cleared"), true)
      }
      $("saveCfgBtn").onclick = async () => {
        const url = $("sbUrl").value || ""
        const key = $("sbKey").value || ""
        saveCfg(url, key)
        closeModal("settingsModal")
        const ok = await initSupabase()
        if (ok) showToast(txt("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§ØªØµØ§Ù„","Saved and connected"), true)
        render()
      }

      $("userBtn").onclick = () => openModal("authModal")
      $("authClose").onclick = () => closeModal("authModal")
      $("signInBtn").onclick = () => doSignIn()
      $("signUpBtn").onclick = () => doSignUp()
      $("magicBtn").onclick = () => doMagic()
      $("signOutBtn").onclick = () => doSignOut()

      $("viewClose").onclick = () => closeModal("viewModal")

      $("langBtn").onclick = () => {
        state.lang = state.lang === "ar" ? "en" : "ar"
        localStorage.setItem("fd_lang", state.lang)
        applyLang()
      }

      $("refreshBtn").onclick = () => render()
      $("testBtn").onclick = () => testAll()

      for (const el of document.querySelectorAll(".tab")) {
        el.onclick = () => setActiveTab(el.dataset.page)
      }

      $("connPill").onclick = () => testAll()
    }

    const doSignIn = async () => {
      const ok = await mustCfg()
      if (!ok) return
      const email = ($("authEmail").value || "").trim()
      const pass = ($("authPass").value || "").trim()
      if (!email || !pass) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±","Enter email and password"))
      try{
        const res = await state.supabase.auth.signInWithPassword({ email, password: pass })
        if (res.error) throw res.error
        showToast(txt("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„","Signed in"), true)
        closeModal("authModal")
        render()
      }catch(err){
        showToast(err.message || String(err))
      }
    }

    const doSignUp = async () => {
      const ok = await mustCfg()
      if (!ok) return
      const email = ($("authEmail").value || "").trim()
      const pass = ($("authPass").value || "").trim()
      if (!email || !pass) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±","Enter email and password"))
      try{
        const res = await state.supabase.auth.signUp({ email, password: pass })
        if (res.error) throw res.error
        showToast(txt("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨","Signed up"), true)
      }catch(err){
        showToast(err.message || String(err))
      }
    }

    const doMagic = async () => {
      const ok = await mustCfg()
      if (!ok) return
      const email = ($("authEmail").value || "").trim()
      if (!email) return showToast(txt("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ","Enter email"))
      try{
        const res = await state.supabase.auth.signInWithOtp({ email })
        if (res.error) throw res.error
        showToast(txt("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯","Magic link sent"), true)
      }catch(err){
        showToast(err.message || String(err))
      }
    }

    const doSignOut = async () => {
      if (!state.supabase) return
      try{
        await state.supabase.auth.signOut()
        showToast(txt("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬","Signed out"), true)
        render()
      }catch(err){
        showToast(err.message || String(err))
      }
    }

    const testAll = async () => {
      loadCfg()
      if (!state.cfg) {
        setConn(false, txt("ØºÙŠØ± Ù…ØªØµÙ„","Offline"))
        showToast(txt("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø§Ù‚ØµØ©","Config missing"))
        return
      }
      const ok = await initSupabase()
      if (!ok) return
      try{
        const p = await state.supabase.from("profiles").select("id").limit(1)
        if (p.error) throw p.error
        showToast(txt("Ø§Ù„Ø§ØªØµØ§Ù„ Ø´ØºØ§Ù„","Connection OK"), true)
      }catch(err){
        showToast(txt("Ø§Ù„Ø§ØªØµØ§Ù„ Ø´ØºØ§Ù„ Ù„ÙƒÙ† ÙÙŠ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ùˆ RLS","Connected but tables or RLS issue") + " Â· " + (err.message || String(err)))
      }
      renderSide()
    }

    const boot = async () => {
      bindGlobal()
      loadCfg()
      applyLang()

      if (state.cfg) await initSupabase()
      renderSide()

      if (state.supabase) {
        const { data } = await state.supabase.auth.getSession()
        state.session = data ? data.session : null
        state.user = state.session ? state.session.user : null
      }

      $("signOutBtn").classList.toggle("hide", !state.user)

      render()
    }

    window.addEventListener("load", boot)
  </script>
</body>
</html>const mustCfg = () => {
    if (!state.cfg) {
      // allow config via URL query one time
      if (!applyCfgFromUrl()) loadCfg()
    }

    const ok = !!(state.cfg && state.cfg.supabaseUrl && state.cfg.anonKey)
    if (!ok) {
      if (!state.warnedNoCfg) {
        toast("ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø· Supabase URL Ùˆ Anon Key")
        state.warnedNoCfg = true
        // help the user immediately
        openSettings()
      }
      return false
    }

    if (!state.supabase) initSupabase()
    return true
  }

  
