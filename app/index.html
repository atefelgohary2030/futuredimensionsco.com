<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0b1220">
<title>Future Dimensions App</title>
<style>
  :root {
    --bg0:#070b12;
    --bg1:#0b1220;
    --card:rgba(255,255,255,.04);
    --card2:rgba(255,255,255,.06);
    --stroke:rgba(255,255,255,.10);
    --text:#e7edf6;
    --muted:#aeb8c8;
    --gold:#c7a357;
    --gold2:#e4c77a;
    --danger:#ff6b6b;
    --ok:#46d39a;
    --shadow: 0 20px 80px rgba(0,0,0,.45);
    --radius: 18px;
    --radius2: 26px;
    --pad: 16px;
    --safe-b: env(safe-area-inset-bottom);
    --safe-t: env(safe-area-inset-top);
  }

  * { box-sizing:border-box }
  html, body { height:100% }
  body {
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Sans", Arial, sans-serif;
    background: radial-gradient(1200px 700px at 20% 0%, rgba(199,163,87,.18), transparent 60%),
                radial-gradient(900px 600px at 80% 20%, rgba(103,157,255,.12), transparent 55%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
    color: var(--text);
    overflow-x:hidden;
  }

  a { color:inherit }
  button, input, textarea {
    font: inherit;
    color: inherit;
  }

  .wrap {
    min-height: 100%;
    display:flex;
    flex-direction:column;
  }

  .topbar {
    padding: calc(14px + var(--safe-t)) 16px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
  }

  .brand {
    display:flex;
    align-items:center;
    gap: 12px;
    min-width: 0;
  }

  .logo {
    width:42px;
    height:42px;
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(199,163,87,.25), rgba(255,255,255,.04));
    border:1px solid rgba(199,163,87,.35);
    display:grid;
    place-items:center;
    box-shadow: var(--shadow);
    flex: 0 0 auto;
  }

  .logo svg { width:22px; height:22px; fill: var(--gold2) }

  .brandtext {
    display:flex;
    flex-direction:column;
    line-height:1.1;
    min-width: 0;
  }
  .brandtext .t1 {
    font-weight: 700;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .brandtext .t2 {
    color: var(--muted);
    font-size: 12px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .actions {
    display:flex;
    align-items:center;
    gap: 8px;
    flex: 0 0 auto;
  }

  .pill {
    border: 1px solid rgba(199,163,87,.35);
    background: rgba(255,255,255,.03);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 999px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border .15s ease;
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .pill:active { transform: scale(.98) }
  .pill:hover { background: rgba(255,255,255,.05) }

  .main {
    flex: 1 1 auto;
    padding: 0 16px 86px;
    max-width: 1050px;
    width: 100%;
    margin: 0 auto;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: var(--radius2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .card + .card { margin-top: 14px }

  .cardhd {
    padding: 14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .cardhd h2 {
    margin: 0;
    font-size: 16px;
    letter-spacing:.2px;
  }
  .sub {
    color: var(--muted);
    font-size: 13px;
    margin-top: 4px;
    line-height: 1.35;
  }

  .cardbd { padding: 14px 16px }

  .row {
    display:flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .row > * { flex: 1 1 220px }

  .field {
    display:flex;
    flex-direction:column;
    gap: 8px;
  }
  .label {
    color: var(--muted);
    font-size: 12px;
  }
  .input, .ta {
    width:100%;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    padding: 12px 12px;
    outline:none;
  }
  .ta { min-height: 96px; resize: vertical }

  .btn {
    border: 1px solid rgba(199,163,87,.35);
    background: rgba(199,163,87,.14);
    color: var(--text);
    padding: 11px 14px;
    border-radius: 14px;
    cursor:pointer;
    transition: transform .08s ease, background .15s ease, border .15s ease;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap: 10px;
    min-height: 42px;
    user-select:none;
  }
  .btn:hover { background: rgba(199,163,87,.20) }
  .btn:active { transform: scale(.98) }
  .btn.secondary {
    border-color: rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
  }
  .btn.danger {
    border-color: rgba(255,107,107,.35);
    background: rgba(255,107,107,.12);
  }
  .btn.block { width: 100% }

  .hint {
    color: var(--muted);
    font-size: 12px;
    line-height: 1.4;
  }
  .msg {
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    font-size: 13px;
    line-height: 1.4;
  }
  .msg.ok { border-color: rgba(70,211,154,.35); background: rgba(70,211,154,.08) }
  .msg.bad { border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.08) }

  .list {
    display:flex;
    flex-direction:column;
    gap: 10px;
  }

  .item {
    display:flex;
    gap: 12px;
    align-items:flex-start;
    padding: 12px 12px;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }

  .icon {
    width: 38px;
    height: 38px;
    border-radius: 14px;
    display:grid;
    place-items:center;
    background: rgba(199,163,87,.12);
    border: 1px solid rgba(199,163,87,.25);
    flex: 0 0 auto;
  }
  .icon svg { width: 18px; height: 18px; fill: var(--gold2) }

  .itxt {
    flex: 1 1 auto;
    min-width:0;
  }
  .itxt .t {
    font-weight: 700;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .itxt .m {
    margin-top: 4px;
    color: var(--muted);
    font-size: 12px;
    line-height: 1.35;
  }

  .itag {
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    color: var(--muted);
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    white-space:nowrap;
  }
  .itag.ok { border-color: rgba(70,211,154,.35); color: #bff3dc; background: rgba(70,211,154,.08) }
  .itag.bad { border-color: rgba(255,107,107,.35); color: #ffd2d2; background: rgba(255,107,107,.08) }

  .bottomnav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 12px 14px calc(12px + var(--safe-b));
    backdrop-filter: blur(14px);
    background: linear-gradient(180deg, rgba(7,11,18,0), rgba(7,11,18,.75) 25%, rgba(7,11,18,.92));
    border-top: 1px solid rgba(255,255,255,.08);
  }

  .nav {
    max-width: 1050px;
    margin: 0 auto;
    display:flex;
    gap: 10px;
  }
  .navbtn {
    flex: 1 1 0;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.03);
    padding: 10px 10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 10px;
    min-height: 48px;
    transition: transform .08s ease, background .15s ease, border .15s ease;
  }
  .navbtn:active { transform: scale(.98) }
  .navbtn.active {
    border-color: rgba(199,163,87,.40);
    background: rgba(199,163,87,.14);
  }
  .navbtn span {
    font-weight: 700;
    font-size: 13px;
  }

  .grid2 {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 760px) {
    .grid2 { grid-template-columns: 1fr }
    .brandtext .t2 { display:none }
  }

  .modal {
    position: fixed;
    inset: 0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    background: rgba(0,0,0,.55);
    padding: 14px 14px calc(14px + var(--safe-b));
    z-index: 50;
  }
  .modal.show { display:flex }

  .sheet {
    width: min(720px, 100%);
    border-radius: 24px;
    background: rgba(10,16,28,.96);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .sheet .hd {
    padding: 14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .sheet .hd .x {
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    width: 40px;
    height: 40px;
    border-radius: 14px;
    cursor:pointer;
    display:grid;
    place-items:center;
  }
  .sheet .bd { padding: 14px 16px }

  .code {
    background: rgba(0,0,0,.22);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 16px;
    padding: 12px;
    white-space: pre-wrap;
    font-size: 12px;
    line-height: 1.5;
    overflow:auto;
  }

  .skeleton {
    height: 14px;
    border-radius: 10px;
    background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.09), rgba(255,255,255,.05));
    background-size: 240% 100%;
    animation: sk 1.2s ease infinite;
  }
  @keyframes sk {
    0% { background-position: 0% 0% }
    100% { background-position: 100% 0% }
  }
</style>

<script>
  ;(function() {
    try {
      var needsReload = false
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(regs) {
          regs.forEach(function(r) { r.unregister(); needsReload = true })
        }).catch(function(){})
      }
      if (window.caches && caches.keys) {
        caches.keys().then(function(keys) {
          keys.forEach(function(k) { caches.delete(k); needsReload = true })
        }).catch(function(){})
      }
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        needsReload = true
      }
      if (needsReload && !sessionStorage.getItem("fd_sw_cleaned")) {
        sessionStorage.setItem("fd_sw_cleaned","1")
        setTimeout(function(){ location.reload() }, 350)
      }
    } catch (e) {}
  })()
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
<script>
  if (!window.supabase) {
    var s=document.createElement("script")
    s.src="https://unpkg.com/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"
    document.head.appendChild(s)
  }
</script>
</head>

<body>
<div class="wrap" id="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M12 2 21 7v10l-9 5-9-5V7l9-5Zm0 2.3L5 7.8v8.4l7 3.9 7-3.9V7.8l-7-3.5Zm0 3.7 5 2.8v5.7l-5 2.8-5-2.8V10.8l5-2.8Z"/></svg>
      </div>
      <div class="brandtext">
        <div class="t1" id="brandTitle">Future Dimensions</div>
        <div class="t2" id="brandSub">Consulting & Business Solutions</div>
      </div>
    </div>
    <div class="actions">
      <button class="pill" id="btnLang">EN</button>
      <button class="pill" id="btnSettings">‚öôÔ∏è</button>
      <button class="pill" id="btnUser">üë§</button>
    </div>
  </div>

  <main class="main" id="main">
    <div class="card">
      <div class="cardhd">
        <div>
          <h2 id="loadingTitle">ÿ¨ÿßÿ±Ÿä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</h2>
          <div class="sub" id="loadingSub">ŸÑŸà ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿ™ÿ∏Ÿáÿ± ŸÅÿßÿ∂Ÿäÿ©ÿå ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸàÿßÿπŸÖŸÑ ÿ™ÿ≠ÿØŸäÿ´</div>
        </div>
        <div class="itag" id="loadingTag">...</div>
      </div>
      <div class="cardbd">
        <div class="skeleton" style="width:60%"></div>
        <div style="height:10px"></div>
        <div class="skeleton" style="width:92%"></div>
        <div style="height:10px"></div>
        <div class="skeleton" style="width:78%"></div>
      </div>
    </div>
  </main>

  <div class="bottomnav">
    <div class="nav" id="nav"></div>
  </div>
</div>

<div class="modal" id="modalUser" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="hd">
      <div id="userTitle" style="font-weight:800">ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
      <button class="x" id="closeUser">‚úï</button>
    </div>
    <div class="bd" id="userBody"></div>
  </div>
</div>

<div class="modal" id="modalSettings" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="hd">
      <div id="settingsTitle" style="font-weight:800">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</div>
      <button class="x" id="closeSettings">‚úï</button>
    </div>
    <div class="bd" id="settingsBody"></div>
  </div>
</div>

<script>
  ;(function() {
    var defaults = {
      supabaseUrl: "https://mifottrhqimqzojiyytq.supabase.co",
      supabaseKey: "sb_publishable_nJKPr9Lk-SppxXMAwLG79g_cz2d5rir",
      buckets: {
        invoices: "Invoices",
        documents: "Documents"
      },
      tables: {
        invoices: "invoices",
        documents: "documents",
        tickets: "tickets",
        meetings: "meetings"
      }
    }

    function readStore(key, fallback) {
      try {
        var v = localStorage.getItem(key)
        if (!v) return fallback
        return JSON.parse(v)
      } catch (e) {
        return fallback
      }
    }

    function writeStore(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)) } catch (e) {}
    }

    var cfg = readStore("fd_cfg_v1", defaults)

    function i18nPack() {
      return {
        ar: {
          dir: "rtl",
          langBtn: "EN",
          home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
          invoices: "ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±",
          documents: "ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™",
          support: "ÿßŸÑÿØÿπŸÖ",
          meetings: "ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπÿßÿ™",
          refresh: "ÿ™ÿ≠ÿØŸäÿ´",
          signIn: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ",
          signUp: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
          signOut: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
          email: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
          password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
          save: "ÿ≠ŸÅÿ∏",
          close: "ÿ•ÿ∫ŸÑÿßŸÇ",
          setup: "ÿ•ÿπÿØÿßÿØ Supabase",
          setupHint: "ŸÑŸà ŸÅŸä ŸÖÿ≤ÿßŸäÿß ŸÖÿ¥ ÿ¥ÿ∫ÿßŸÑÿ©ÿå ÿßŸÑÿ≥ÿ®ÿ® ÿ∫ÿßŸÑÿ®ÿß ÿ¨ÿØÿßŸàŸÑ ÿ£Ÿà ÿ≥Ÿäÿßÿ≥ÿßÿ™ RLS",
          statusOk: "ÿ¨ÿßŸáÿ≤",
          statusWarn: "ŸÖÿ≠ÿ™ÿßÿ¨ ÿ•ÿπÿØÿßÿØ",
          upload: "ÿ±ŸÅÿπ",
          chooseFile: "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ",
          title: "ÿßŸÑÿπŸÜŸàÿßŸÜ",
          message: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™",
          subject: "ÿßŸÑŸÖŸàÿ∂Ÿàÿπ",
          date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",
          time: "ÿßŸÑŸàŸÇÿ™",
          amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫",
          state: "ÿßŸÑÿ≠ÿßŸÑÿ©",
          created: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ",
          download: "ÿ™ÿ≠ŸÖŸäŸÑ",
          noFile: "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ",
          send: "ÿ•ÿ±ÿ≥ÿßŸÑ",
          loading: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ",
          done: "ÿ™ŸÖ",
          failed: "ŸÅÿ¥ŸÑ",
          open: "ŸÅÿ™ÿ≠"
        },
        en: {
          dir: "ltr",
          langBtn: "ÿπÿ±ÿ®Ÿä",
          home: "Home",
          invoices: "Invoices",
          documents: "Documents",
          support: "Support",
          meetings: "Meetings",
          refresh: "Refresh",
          signIn: "Sign in",
          signUp: "Create account",
          signOut: "Sign out",
          email: "Email",
          password: "Password",
          save: "Save",
          close: "Close",
          setup: "Supabase setup",
          setupHint: "If something fails, it is usually missing tables or RLS policies",
          statusOk: "Ready",
          statusWarn: "Needs setup",
          upload: "Upload",
          chooseFile: "Choose file",
          title: "Title",
          message: "Notes",
          subject: "Subject",
          date: "Date",
          time: "Time",
          amount: "Amount",
          state: "Status",
          created: "Created",
          download: "Download",
          noFile: "No file",
          send: "Send",
          loading: "Loading",
          done: "Done",
          failed: "Failed",
          open: "Open"
        }
      }
    }

    var state = {
      lang: readStore("fd_lang_v1", "ar"),
      cfg: cfg,
      sb: null,
      user: null,
      session: null,
      tab: "home"
    }

    var t = i18nPack()

    function tx(key) {
      var pack = state.lang === "en" ? t.en : t.ar
      return pack[key] || key
    }

    function setLang(newLang) {
      state.lang = newLang
      writeStore("fd_lang_v1", newLang)
      document.documentElement.lang = newLang === "en" ? "en" : "ar"
      document.documentElement.dir = (newLang === "en" ? t.en.dir : t.ar.dir)
      document.getElementById("btnLang").textContent = tx("langBtn")
      renderNav()
      renderCurrent()
    }

    function el(tag, attrs, children) {
      var e = document.createElement(tag)
      if (attrs) {
        Object.keys(attrs).forEach(function(k) {
          if (k === "class") e.className = attrs[k]
          else if (k === "html") e.innerHTML = attrs[k]
          else if (k.indexOf("on") === 0 && typeof attrs[k] === "function") e.addEventListener(k.slice(2), attrs[k])
          else e.setAttribute(k, attrs[k])
        })
      }
      if (children) {
        children.forEach(function(c) {
          if (c === null || c === undefined) return
          if (typeof c === "string") e.appendChild(document.createTextNode(c))
          else e.appendChild(c)
        })
      }
      return e
    }

    function toast(kind, text) {
      var main = document.getElementById("main")
      var box = el("div", { class: "msg " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "") }, [text])
      main.prepend(box)
      setTimeout(function() {
        try { box.remove() } catch(e) {}
      }, 4200)
    }

    function showModal(id, show) {
      var m = document.getElementById(id)
      if (!m) return
      if (show) m.classList.add("show")
      else m.classList.remove("show")
    }

    function safeStr(v) {
      if (v === null || v === undefined) return ""
      return String(v)
    }

    function fmtDate(ts) {
      try {
        var d = new Date(ts)
        if (isNaN(d.getTime())) return safeStr(ts)
        return d.toLocaleString(state.lang === "en" ? "en-US" : "ar-EG")
      } catch (e) {
        return safeStr(ts)
      }
    }

    function ensureSupabaseReady() {
      return new Promise(function(resolve, reject) {
        var tries = 0
        function tick() {
          tries += 1
          if (window.supabase && window.supabase.createClient) return resolve()
          if (tries > 40) return reject(new Error("Supabase library not loaded"))
          setTimeout(tick, 120)
        }
        tick()
      })
    }

    function buildClient() {
      state.sb = window.supabase.createClient(state.cfg.supabaseUrl, state.cfg.supabaseKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      })
    }

    async function loadSession() {
      var r = await state.sb.auth.getSession()
      state.session = r.data.session || null
      state.user = state.session ? state.session.user : null
    }

    async function signIn(email, password) {
      var r = await state.sb.auth.signInWithPassword({ email: email, password: password })
      if (r.error) throw r.error
      await loadSession()
    }

    async function signUp(email, password) {
      var r = await state.sb.auth.signUp({ email: email, password: password })
      if (r.error) throw r.error
      await loadSession()
    }

    async function signOut() {
      await state.sb.auth.signOut()
      await loadSession()
    }

    function navItems() {
      return [
        { id: "home", label: tx("home") },
        { id: "invoices", label: tx("invoices") },
        { id: "documents", label: tx("documents") },
        { id: "support", label: tx("support") },
        { id: "meetings", label: tx("meetings") }
      ]
    }

    function renderNav() {
      var nav = document.getElementById("nav")
      nav.innerHTML = ""
      navItems().forEach(function(it) {
        var b = el("button", {
          class: "navbtn" + (state.tab === it.id ? " active" : ""),
          onclick: function() { state.tab = it.id; renderNav(); renderCurrent() }
        }, [el("span", null, [it.label])])
        nav.appendChild(b)
      })
    }

    function authGate() {
      if (state.user) return null
      return el("div", { class: "msg bad" }, [
        state.lang === "en"
          ? "Please sign in to use the app"
          : "ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿπÿ¥ÿßŸÜ ÿ™ÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"
      ])
    }

    function requireUser() {
      if (!state.user) throw new Error(state.lang === "en" ? "Not signed in" : "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ")
      return state.user
    }

    async function checkTable(tableName) {
      try {
        var r = await state.sb.from(tableName).select("*").limit(1)
        if (r.error) return { ok: false, error: r.error.message }
        return { ok: true }
      } catch (e) {
        return { ok: false, error: e.message || String(e) }
      }
    }

    function sqlSetupText() {
      var docsTable = state.cfg.tables.documents
      var ticketsTable = state.cfg.tables.tickets
      var meetingsTable = state.cfg.tables.meetings
      var docsBucket = state.cfg.buckets.documents
      var invBucket = state.cfg.buckets.invoices

      return `-- 1) Meetings table
create table if not exists public.${meetingsTable} (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  title text not null,
  meeting_date date not null,
  meeting_time text,
  notes text,
  status text default 'open',
  created_at timestamptz default now()
)

alter table public.${meetingsTable} enable row level security

drop policy if exists "meetings_select_own" on public.${meetingsTable}
create policy "meetings_select_own" on public.${meetingsTable}
for select to authenticated
using (user_id = auth.uid())

drop policy if exists "meetings_insert_own" on public.${meetingsTable}
create policy "meetings_insert_own" on public.${meetingsTable}
for insert to authenticated
with check (user_id = auth.uid())

-- 2) Documents table RLS
alter table public.${docsTable} enable row level security

drop policy if exists "documents_select_own" on public.${docsTable}
create policy "documents_select_own" on public.${docsTable}
for select to authenticated
using (user_id = auth.uid())

drop policy if exists "documents_insert_own" on public.${docsTable}
create policy "documents_insert_own" on public.${docsTable}
for insert to authenticated
with check (user_id = auth.uid())

-- 3) Tickets table RLS
alter table public.${ticketsTable} enable row level security

drop policy if exists "tickets_select_own" on public.${ticketsTable}
create policy "tickets_select_own" on public.${ticketsTable}
for select to authenticated
using (user_id = auth.uid())

drop policy if exists "tickets_insert_own" on public.${ticketsTable}
create policy "tickets_insert_own" on public.${ticketsTable}
for insert to authenticated
with check (user_id = auth.uid())

-- 4) Storage policies for Documents bucket
drop policy if exists "documents_read_own" on storage.objects
create policy "documents_read_own"
on storage.objects
for select
to authenticated
using (
  bucket_id = '${docsBucket}'
  and (storage.foldername(name))[1] = auth.uid()::text
)

drop policy if exists "documents_upload_own" on storage.objects
create policy "documents_upload_own"
on storage.objects
for insert
to authenticated
with check (
  bucket_id = '${docsBucket}'
  and (storage.foldername(name))[1] = auth.uid()::text
)

-- 5) Storage policies for Invoices bucket
drop policy if exists "invoices_read_own" on storage.objects
create policy "invoices_read_own"
on storage.objects
for select
to authenticated
using (
  bucket_id = '${invBucket}'
  and (storage.foldername(name))[1] = auth.uid()::text
)

drop policy if exists "invoices_upload_own" on storage.objects
create policy "invoices_upload_own"
on storage.objects
for insert
to authenticated
with check (
  bucket_id = '${invBucket}'
  and (storage.foldername(name))[1] = auth.uid()::text
)`
    }

    function iconShield() {
      var s = document.createElementNS("http://www.w3.org/2000/svg", "svg")
      s.setAttribute("viewBox","0 0 24 24")
      s.innerHTML = '<path d="M12 2 20 6v6c0 5-3.4 9.4-8 10-4.6-.6-8-5-8-10V6l8-4Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>'
      s.style.color = "var(--gold2)"
      return s
    }

    function iconDoc() {
      var s = document.createElementNS("http://www.w3.org/2000/svg", "svg")
      s.setAttribute("viewBox","0 0 24 24")
      s.innerHTML = '<path d="M7 2h7l5 5v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm7 1.5V8h4.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
      s.style.color="var(--gold2)"
      return s
    }

    function iconFolder() {
      var s = document.createElementNS("http://www.w3.org/2000/svg", "svg")
      s.setAttribute("viewBox","0 0 24 24")
      s.innerHTML = '<path d="M3 6a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>'
      s.style.color="var(--gold2)"
      return s
    }

    function iconTicket() {
      var s = document.createElementNS("http://www.w3.org/2000/svg", "svg")
      s.setAttribute("viewBox","0 0 24 24")
      s.innerHTML = '<path d="M4 9V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2a2 2 0 0 0 0 4v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2a2 2 0 0 0 0-4Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>'
      s.style.color="var(--gold2)"
      return s
    }

    function iconCalendar() {
      var s = document.createElementNS("http://www.w3.org/2000/svg", "svg")
      s.setAttribute("viewBox","0 0 24 24")
      s.innerHTML = '<path d="M7 2v3M17 2v3M4 7h16M5 5h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>'
      s.style.color="var(--gold2)"
      return s
    }

    function quickTile(label, emoji, onTap) {
      return el("div", { class:"card", style:"box-shadow:none" }, [
        el("div", { class:"cardbd", style:"display:flex; align-items:center; justify-content:space-between; gap:12px" }, [
          el("div", null, [
            el("div", { style:"font-size:12px; color:var(--muted)" }, [emoji]),
            el("div", { style:"margin-top:6px; font-weight:800" }, [label])
          ]),
          el("button", { class:"btn", onclick: onTap }, [tx("open")])
        ])
      ])
    }

    async function renderSetupStatus() {
      var main = document.getElementById("main")
      var statusCard = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [state.lang==="en" ? "Database status" : "ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ÿØÿßŸàŸÑ"]),
            el("div", { class:"sub" }, [state.lang==="en" ? "Checks required tables" : "ŸÅÿ≠ÿµ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©"])
          ]),
          el("div", { class:"itag" }, [tx("loading")])
        ]),
        el("div", { class:"cardbd" }, [
          el("div", { class:"list", id:"statusList" }, [])
        ])
      ])
      main.appendChild(statusCard)

      var items = [
        state.cfg.tables.invoices,
        state.cfg.tables.documents,
        state.cfg.tables.tickets,
        state.cfg.tables.meetings
      ]

      var list = statusCard.querySelector("#statusList")
      list.innerHTML = ""
      items.forEach(function(name) {
        list.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconShield()]),
          el("div", { class:"itxt" }, [el("div", { class:"t" }, [name]), el("div", { class:"m" }, ["..."])]),
          el("div", { class:"itag" }, [tx("loading")])
        ]))
      })

      var results = []
      for (var i=0;i<items.length;i++) results.push(await checkTable(items[i]))

      list.innerHTML = ""
      results.forEach(function(r, idx) {
        var ok = r.ok
        list.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconShield()]),
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, [items[idx]]),
            el("div", { class:"m" }, [r.error ? safeStr(r.error) : ""])
          ]),
          el("div", { class:"itag " + (ok ? "ok" : "bad") }, [ok ? tx("statusOk") : tx("statusWarn")])
        ]))
      })

      var allOk = results.every(function(x) { return x.ok })
      var tag = statusCard.querySelector(".itag")
      tag.textContent = allOk ? tx("statusOk") : tx("statusWarn")
      tag.className = "itag " + (allOk ? "ok" : "bad")
    }

    function renderHome() {
      var main = document.getElementById("main")
      var gate = authGate()

      var c = el("div", { class: "card" }, [
        el("div", { class: "cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("home")]),
            el("div", { class:"sub" }, [
              state.user ? safeStr(state.user.email) : (state.lang === "en" ? "Not signed in" : "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ")
            ])
          ]),
          el("button", { class:"btn secondary", onclick: function() { renderCurrent(true) } }, [tx("refresh")])
        ]),
        el("div", { class:"cardbd" }, [
          gate,
          el("div", { class:"grid2", style:"margin-top:12px" }, [
            quickTile(tx("invoices"), "üìÑ", function() { state.tab="invoices"; renderNav(); renderCurrent() }),
            quickTile(tx("documents"), "üìÅ", function() { state.tab="documents"; renderNav(); renderCurrent() }),
            quickTile(tx("support"), "üé´", function() { state.tab="support"; renderNav(); renderCurrent() }),
            quickTile(tx("meetings"), "üìÖ", function() { state.tab="meetings"; renderNav(); renderCurrent() })
          ]),
          el("div", { class:"msg", style:"margin-top:12px" }, [
            state.lang === "en"
              ? "If any section shows a blank screen, open Settings and press Save, then Refresh"
              : "ŸÑŸà ÿ£Ÿä ÿµŸÅÿ≠ÿ© ÿ®ÿ™ÿ∏Ÿáÿ± ŸÅÿßÿ∂Ÿäÿ©ÿå ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ Ÿàÿßÿ∂ÿ∫ÿ∑ ÿ≠ŸÅÿ∏ ÿ´ŸÖ ÿ™ÿ≠ÿØŸäÿ´"
          ])
        ])
      ])

      var setup = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("setup")]),
            el("div", { class:"sub" }, [tx("setupHint")])
          ]),
          el("div", { class:"itag" }, ["SQL"])
        ]),
        el("div", { class:"cardbd" }, [
          el("div", { class:"hint" }, [
            state.lang === "en"
              ? "Paste this SQL in Supabase SQL Editor once"
              : "ÿßŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ ÿØŸá ŸÅŸä Supabase SQL Editor ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©"
          ]),
          el("div", { class:"code", id:"setupSql" }, [sqlSetupText()]),
          el("div", { style:"height:10px" }),
          el("button", {
            class:"btn block secondary",
            onclick: function() {
              try {
                var ta = document.createElement("textarea")
                ta.value = document.getElementById("setupSql").innerText
                document.body.appendChild(ta)
                ta.select()
                document.execCommand("copy")
                ta.remove()
                toast("ok", state.lang==="en" ? "Copied" : "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ")
              } catch (e) {
                toast("bad", state.lang==="en" ? "Copy failed" : "ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ")
              }
            }
          }, [state.lang==="en" ? "Copy SQL" : "ŸÜÿ≥ÿÆ SQL"])
        ])
      ])

      main.innerHTML = ""
      main.appendChild(c)
      main.appendChild(setup)

      if (state.user) renderSetupStatus()
    }

    async function downloadFromBucket(bucket, path) {
      requireUser()
      var r = await state.sb.storage.from(bucket).createSignedUrl(path, 120)
      if (r.error) throw r.error
      var url = r.data.signedUrl
      var a = document.createElement("a")
      a.href = url
      a.target = "_blank"
      a.rel = "noopener"
      document.body.appendChild(a)
      a.click()
      a.remove()
    }

    async function downloadDocument(doc) {
      var bucket = state.cfg.buckets.documents
      var key = doc && doc.storage_path ? String(doc.storage_path) : ""
      var baseName = (doc && (doc.name_en || doc.name_ar)) ? String(doc.name_en || doc.name_ar) : ""
      var userFolder = doc && doc.user_id ? String(doc.user_id) : ""

      var candidates = []
      if (key) candidates.push(key)
      if (userFolder && baseName) candidates.push(userFolder + "/" + baseName)

      // try direct candidates
      for (var i = 0; i < candidates.length; i++) {
        try {
          await downloadFromBucket(bucket, candidates[i])
          return
        } catch (e) {
          // continue
        }
      }

      // fallback: list user folder and try to locate matching object name
      if (userFolder) {
        var listRes = await state.sb.storage.from(bucket).list(userFolder, { limit: 100 })
        if (!listRes.error && listRes.data && listRes.data.length) {
          var wanted = baseName.toLowerCase()
          var pick = null
          if (wanted) {
            for (var j = 0; j < listRes.data.length; j++) {
              var n = String(listRes.data[j].name || "").toLowerCase()
              if (n.indexOf(wanted) !== -1) { pick = listRes.data[j]; break }
            }
          }
          if (!pick) pick = listRes.data[0]
          if (pick && pick.name) {
            await downloadFromBucket(bucket, userFolder + "/" + pick.name)
            return
          }
        }
      }

      throw new Error(state.lang === "en" ? "File not found in storage. Please re-upload it." : "ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ. ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßÿ±ŸÅÿπŸá ŸÖŸÜ ÿ¨ÿØŸäÿØ")
    }


    function renderInvoices() {
      var main = document.getElementById("main")
      var gate = authGate()

      var list = el("div", { class:"list", id:"invList" }, [
        el("div", { class:"item" }, [
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, [tx("loading")]),
            el("div", { class:"m" }, ["..."])
          ])
        ])
      ])

      var card = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("invoices")]),
            el("div", { class:"sub" }, [
              state.lang==="en" ? "Your invoices and attachments" : "ŸÅŸàÿßÿ™Ÿäÿ±ŸÉ ŸàÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©"
            ])
          ]),
          el("button", { class:"btn secondary", onclick: function() { renderCurrent(true) } }, [tx("refresh")])
        ]),
        el("div", { class:"cardbd" }, [gate, list])
      ])

      main.innerHTML = ""
      main.appendChild(card)

      if (state.user) loadInvoices(list).catch(function(e) { toast("bad", e.message || String(e)) })
    }

    async function loadInvoices(listEl) {
      requireUser()
      var table = state.cfg.tables.invoices
      var r = await state.sb.from(table).select("*").order("created_at", { ascending: false }).limit(50)
      if (r.error) throw r.error
      var rows = r.data || []
      listEl.innerHTML = ""
      if (!rows.length) {
        listEl.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "No invoices yet" : "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ±"]))
        return
      }

      rows.forEach(function(row) {
        var hasFile = !!row.storage_path
        var meta = []
        if (row.amount !== undefined && row.amount !== null) meta.push(tx("amount")+": "+row.amount)
        if (row.status) meta.push(tx("state")+": "+row.status)
        if (row.created_at) meta.push(tx("created")+": "+fmtDate(row.created_at))

        listEl.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconDoc()]),
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, ["#"+safeStr(row.id).slice(0,8)]),
            el("div", { class:"m" }, [meta.join(" ‚Ä¢ ")])
          ]),
          el("button", {
            class:"btn " + (hasFile ? "" : "secondary"),
            onclick: function() {
              if (!hasFile) return toast("bad", state.lang==="en" ? "No attachment" : "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ")
              downloadFromBucket(state.cfg.buckets.invoices, row.storage_path).catch(function(e) {
                toast("bad", e.message || String(e))
              })
            }
          }, [tx("download")])
        ]))
      })
    }

    function renderDocuments() {
      var main = document.getElementById("main")
      var gate = authGate()

      var fileInput = el("input", { class:"input", type:"file" })
      var titleInput = el("input", { class:"input", type:"text", placeholder: tx("title") })

      var uploadBtn = el("button", {
        class:"btn",
        onclick: function() {
          uploadDocument(fileInput.files[0], titleInput.value).then(function() {
            titleInput.value = ""
            fileInput.value = ""
            toast("ok", tx("done"))
            renderCurrent(true)
          }).catch(function(e) {
            toast("bad", tx("failed") + ": " + (e.message || String(e)))
          })
        }
      }, [tx("upload")])

      var list = el("div", { class:"list", id:"docList" }, [
        el("div", { class:"item" }, [
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, [tx("loading")]),
            el("div", { class:"m" }, ["..."])
          ])
        ])
      ])

      var card = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("documents")]),
            el("div", { class:"sub" }, [state.lang==="en" ? "Upload and manage your documents" : "ÿ±ŸÅÿπ Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ"])
          ]),
          el("button", { class:"btn secondary", onclick: function() { renderCurrent(true) } }, [tx("refresh")])
        ]),
        el("div", { class:"cardbd" }, [
          gate,
          el("div", { class:"row", style:"margin-top:10px" }, [
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("chooseFile")]), fileInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("title")]), titleInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [" "]), uploadBtn])
          ]),
          el("div", { style:"height:10px" }),
          list
        ])
      ])

      main.innerHTML = ""
      main.appendChild(card)

      if (state.user) loadDocuments(list).catch(function(e) { toast("bad", e.message || String(e)) })
    }

    async function uploadDocument(file, title) {
      var user = requireUser()
      if (!file) throw new Error(state.lang==="en" ? "Choose a file" : "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ")

      var tbl = state.cfg.tables.documents
      var bucket = state.cfg.buckets.documents

      var cleanName = file.name.replace(/[^a-zA-Z0-9._-]+/g, "_")
      var path = user.id + "/" + Date.now() + "_" + cleanName

      var up = await state.sb.storage.from(bucket).upload(path, file, { cacheControl: "3600", upsert: false })
      if (up.error) throw up.error

      var ins = await state.sb.from(tbl).insert({
        user_id: user.id,
        type: "report",
        name_en: title || cleanName,
        name_ar: title || cleanName,
        storage_path: path
      }).select("*").single()
      if (ins.error) throw ins.error
      return ins.data
    }

    async function loadDocuments(listEl) {
      requireUser()
      var tbl = state.cfg.tables.documents
      var r = await state.sb.from(tbl).select("*").order("created_at", { ascending: false }).limit(80)
      if (r.error) throw r.error
      var rows = r.data || []
      listEl.innerHTML = ""
      if (!rows.length) {
        listEl.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "No documents yet" : "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™"]))
        return
      }

      rows.forEach(function(row) {
        var hasFile = !!row.storage_path
        var meta = []
        if (row.type) meta.push(row.type)
        if (row.created_at) meta.push(fmtDate(row.created_at))
        var title = row.name_ar || row.name_en || ("#"+safeStr(row.id).slice(0,8))

        listEl.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconFolder()]),
          el("div", { class:"itxt" }, [el("div", { class:"t" }, [safeStr(title)]), el("div", { class:"m" }, [meta.join(" ‚Ä¢ ")])]),
          el("button", {
            class:"btn " + (hasFile ? "" : "secondary"),
            onclick: function() {
              if (!hasFile) return toast("bad", state.lang==="en" ? "No file path" : "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿßÿ± ŸÖŸÑŸÅ")
              downloadFromBucket(state.cfg.buckets.documents, row.storage_path).catch(function(e) { toast("bad", e.message || String(e)) })
            }
          }, [tx("download")])
        ]))
      })
    }

    function renderSupport() {
      var main = document.getElementById("main")
      var gate = authGate()

      var subjectInput = el("input", { class:"input", type:"text", placeholder: tx("subject") })
      var messageInput = el("textarea", { class:"ta", placeholder: tx("message") })

      var sendBtn = el("button", {
        class:"btn",
        onclick: function() {
          createTicket(subjectInput.value, messageInput.value).then(function() {
            subjectInput.value = ""
            messageInput.value = ""
            toast("ok", tx("done"))
            renderCurrent(true)
          }).catch(function(e) {
            toast("bad", tx("failed") + ": " + (e.message || String(e)))
          })
        }
      }, [tx("send")])

      var list = el("div", { class:"list", id:"ticketList" }, [])

      var card = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("support")]),
            el("div", { class:"sub" }, [state.lang==="en" ? "Create and track support tickets" : "ÿ•ŸÜÿ¥ÿßÿ° ŸàŸÖÿ™ÿßÿ®ÿπÿ© ÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑÿØÿπŸÖ"])
          ]),
          el("button", { class:"btn secondary", onclick: function() { renderCurrent(true) } }, [tx("refresh")])
        ]),
        el("div", { class:"cardbd" }, [
          gate,
          el("div", { class:"row", style:"margin-top:10px" }, [
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("subject")]), subjectInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("message")]), messageInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [" "]), sendBtn])
          ]),
          el("div", { style:"height:10px" }),
          list
        ])
      ])

      main.innerHTML = ""
      main.appendChild(card)

      if (state.user) loadTickets(list).catch(function(e) { toast("bad", e.message || String(e)) })
      else list.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "Sign in to view tickets" : "ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ±"]))
    }

    async function createTicket(subject, message) {
      var user = requireUser()
      if (!subject) throw new Error(state.lang === "en" ? "Subject is required" : "ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ŸÖÿ∑ŸÑŸàÿ®")
      if (!message) throw new Error(state.lang === "en" ? "Message is required" : "ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©")

      var tbl = state.cfg.tables.tickets
      var payloads = [
        { user_id: user.id, subject: subject, message: message, status: "open" },
        { user_id: user.id, title: subject, message: message, status: "open" },
        { user_id: user.id, subject: subject, notes: message, status: "open" },
        { user_id: user.id, title: subject, notes: message, status: "open" },
        { user_id: user.id, subject: subject, description: message, status: "open" },
        { user_id: user.id, title: subject, description: message, status: "open" },
        { user_id: user.id, topic: subject, message: message, status: "open" },
        { user_id: user.id, topic: subject, content: message, status: "open" }
      ]

      var lastErr = null
      for (var i = 0; i < payloads.length; i++) {
        var res = await state.sb.from(tbl).insert(payloads[i]).select("*").single()
        if (!res.error) return res.data
        lastErr = res.error
        var msg = String(res.error.message || "")
        if (msg.indexOf("Could not find") === -1 && msg.indexOf("schema cache") === -1 && msg.indexOf("column") === -1) {
          break
        }
      }
      throw lastErr || new Error(state.lang === "en" ? "Failed to create ticket" : "ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ©")
    }

    async function loadTickets(listEl) {
      requireUser()
      var tbl = state.cfg.tables.tickets
      var r = await state.sb.from(tbl).select("*").order("created_at", { ascending: false }).limit(80)
      if (r.error) throw r.error
      var rows = r.data || []
      listEl.innerHTML = ""
      if (!rows.length) {
        listEl.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "No tickets yet" : "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∞ÿßŸÉÿ±"]))
        return
      }

      rows.forEach(function(row) {
        var meta = []
        if (row.status) meta.push(tx("state")+": "+row.status)
        if (row.created_at) meta.push(fmtDate(row.created_at))
        listEl.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconTicket()]),
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, [safeStr(row.subject || ("#"+safeStr(row.id).slice(0,8)))]),
            el("div", { class:"m" }, [meta.join(" ‚Ä¢ ") + (row.message ? " ‚Ä¢ " + safeStr(row.message) : "")])
          ]),
          el("div", { class:"itag ok" }, [safeStr(row.status || "open")])
        ]))
      })
    }

    function renderMeetings() {
      var main = document.getElementById("main")
      var gate = authGate()

      var titleInput = el("input", { class:"input", type:"text", placeholder: tx("subject") })
      var dateInput = el("input", { class:"input", type:"date" })
      var timeInput = el("input", { class:"input", type:"time", required:true, value:"10:00" })
      var notesInput = el("textarea", { class:"ta", placeholder: tx("message") })

      var sendBtn = el("button", {
        class:"btn",
        onclick: function() {
          createMeeting(titleInput.value, dateInput.value, timeInput.value, notesInput.value).then(function() {
            titleInput.value=""
            notesInput.value=""
            toast("ok", tx("done"))
            renderCurrent(true)
          }).catch(function(e) {
            toast("bad", tx("failed") + ": " + (e.message || String(e)))
          })
        }
      }, [tx("send")])

      var list = el("div", { class:"list", id:"meetList" }, [])

      var card = el("div", { class:"card" }, [
        el("div", { class:"cardhd" }, [
          el("div", null, [
            el("h2", null, [tx("meetings")]),
            el("div", { class:"sub" }, [state.lang==="en" ? "Request a meeting and track status" : "ÿ∑ŸÑÿ® ÿßÿ¨ÿ™ŸÖÿßÿπ ŸàŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ≠ÿßŸÑÿ©"])
          ]),
          el("button", { class:"btn secondary", onclick: function() { renderCurrent(true) } }, [tx("refresh")])
        ]),
        el("div", { class:"cardbd" }, [
          gate,
          el("div", { class:"row", style:"margin-top:10px" }, [
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("subject")]), titleInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("date")]), dateInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("time")]), timeInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [tx("message")]), notesInput]),
            el("div", { class:"field" }, [el("div", { class:"label" }, [" "]), sendBtn])
          ]),
          el("div", { style:"height:10px" }),
          list
        ])
      ])

      main.innerHTML = ""
      main.appendChild(card)

      if (state.user) loadMeetings(list).catch(function(e) { toast("bad", e.message || String(e)) })
      else list.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "Sign in to view meetings" : "ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπÿßÿ™"]))
    }

    async function createMeeting(title, date, time, notes) {
      var user = requireUser()
      if (!title) throw new Error(state.lang === "en" ? "Title is required" : "ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÖÿ∑ŸÑŸàÿ®")
      if (!date) throw new Error(state.lang === "en" ? "Date is required" : "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖÿ∑ŸÑŸàÿ®")

      var timeVal = time || "10:00"
      var tbl = state.cfg.tables.meetings

      var payloads = [
        { user_id: user.id, title: title, meeting_date: date, meeting_time: timeVal, notes: notes || "" },
        { user_id: user.id, subject: title, meeting_date: date, meeting_time: timeVal, notes: notes || "" },
        { user_id: user.id, title: title, date: date, time: timeVal, notes: notes || "" },
        { user_id: user.id, title: title, meeting_date: date, meeting_time: timeVal, message: notes || "" },
        { user_id: user.id, subject: title, date: date, time: timeVal, message: notes || "" }
      ]

      var lastErr = null
      for (var i = 0; i < payloads.length; i++) {
        var res = await state.sb.from(tbl).insert(payloads[i]).select("*").single()
        if (!res.error) return res.data
        lastErr = res.error
        var msg = String(res.error.message || "")
        if (msg.indexOf("Could not find") === -1 && msg.indexOf("schema cache") === -1 && msg.indexOf("column") === -1 && msg.indexOf("violates") === -1) {
          break
        }
      }
      throw lastErr || new Error(state.lang === "en" ? "Failed to create meeting" : "ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπ")
    }

    async function loadMeetings(listEl) {
      requireUser()
      var tbl = state.cfg.tables.meetings
      var r = await state.sb.from(tbl).select("*").order("created_at", { ascending: false }).limit(80)
      if (r.error) throw r.error
      var rows = r.data || []
      listEl.innerHTML = ""
      if (!rows.length) {
        listEl.appendChild(el("div", { class:"msg" }, [state.lang==="en" ? "No meetings yet" : "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿßÿ¨ÿ™ŸÖÿßÿπÿßÿ™"]))
        return
      }

      rows.forEach(function(row) {
        var meta = []
        if (row.status) meta.push(tx("state")+": "+row.status)
        if (row.meeting_date) meta.push(tx("date")+": "+row.meeting_date)
        if (row.meeting_time) meta.push(tx("time")+": "+row.meeting_time)
        if (row.created_at) meta.push(fmtDate(row.created_at))
        listEl.appendChild(el("div", { class:"item" }, [
          el("div", { class:"icon" }, [iconCalendar()]),
          el("div", { class:"itxt" }, [
            el("div", { class:"t" }, [safeStr(row.title)]),
            el("div", { class:"m" }, [meta.join(" ‚Ä¢ ") + (row.notes ? " ‚Ä¢ " + safeStr(row.notes) : "")])
          ]),
          el("div", { class:"itag ok" }, [safeStr(row.status || "open")])
        ]))
      })
    }

    function renderSettings() {
      var body = document.getElementById("settingsBody")
      body.innerHTML = ""

      var sbUrl = el("input", { class:"input", value: state.cfg.supabaseUrl })
      var sbKey = el("input", { class:"input", value: state.cfg.supabaseKey })
      var bInv = el("input", { class:"input", value: state.cfg.buckets.invoices })
      var bDoc = el("input", { class:"input", value: state.cfg.buckets.documents })
      var tInv = el("input", { class:"input", value: state.cfg.tables.invoices })
      var tDoc = el("input", { class:"input", value: state.cfg.tables.documents })
      var tTick = el("input", { class:"input", value: state.cfg.tables.tickets })
      var tMeet = el("input", { class:"input", value: state.cfg.tables.meetings })

      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, ["Supabase URL"]), sbUrl]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, ["Supabase Key"]), sbKey]))
      body.appendChild(el("div", { style:"height:10px" }))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Invoices bucket" : "Bucket ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±"]), bInv]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Documents bucket" : "Bucket ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™"]), bDoc]))
      body.appendChild(el("div", { style:"height:10px" }))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Invoices table" : "ÿ¨ÿØŸàŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±"]), tInv]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Documents table" : "ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™"]), tDoc]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Tickets table" : "ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ±"]), tTick]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [state.lang==="en" ? "Meetings table" : "ÿ¨ÿØŸàŸÑ ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπÿßÿ™"]), tMeet]))
      body.appendChild(el("div", { style:"height:12px" }))

      body.appendChild(el("button", {
        class:"btn block",
        onclick: async function() {
          state.cfg.supabaseUrl = sbUrl.value.trim()
          state.cfg.supabaseKey = sbKey.value.trim()
          state.cfg.buckets.invoices = bInv.value.trim() || "Invoices"
          state.cfg.buckets.documents = bDoc.value.trim() || "Documents"
          state.cfg.tables.invoices = tInv.value.trim() || "invoices"
          state.cfg.tables.documents = tDoc.value.trim() || "documents"
          state.cfg.tables.tickets = tTick.value.trim() || "tickets"
          state.cfg.tables.meetings = tMeet.value.trim() || "meetings"
          writeStore("fd_cfg_v1", state.cfg)

          try {
            await ensureSupabaseReady()
            buildClient()
            await loadSession()
            renderNav()
            renderCurrent(true)
            toast("ok", tx("done"))
            showModal("modalSettings", false)
          } catch (e) {
            toast("bad", e.message || String(e))
          }
        }
      }, [tx("save")]))

      body.appendChild(el("div", { style:"height:10px" }))
      body.appendChild(el("button", {
        class:"btn block danger",
        onclick: function() {
          try {
            localStorage.removeItem("fd_cfg_v1")
            localStorage.removeItem("fd_lang_v1")
            toast("ok", state.lang==="en" ? "Reset done" : "ÿ™ŸÖÿ™ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑")
            location.reload()
          } catch (e) {
            toast("bad", e.message || String(e))
          }
        }
      }, [state.lang==="en" ? "Reset app" : "ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"]))
    }

    function renderUserModal() {
      var body = document.getElementById("userBody")
      body.innerHTML = ""

      if (state.user) {
        body.appendChild(el("div", { class:"msg ok" }, [
          (state.lang==="en" ? "Signed in as " : "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ") + safeStr(state.user.email)
        ]))
        body.appendChild(el("button", {
          class:"btn block danger",
          onclick: function() {
            signOut().then(function() {
              toast("ok", tx("done"))
              showModal("modalUser", false)
              renderCurrent(true)
            }).catch(function(e) {
              toast("bad", e.message || String(e))
            })
          }
        }, [tx("signOut")]))
        return
      }

      var email = el("input", { class:"input", type:"email", placeholder: tx("email") })
      var pass = el("input", { class:"input", type:"password", placeholder: tx("password") })

      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [tx("email")]), email]))
      body.appendChild(el("div", { class:"field" }, [el("div", { class:"label" }, [tx("password")]), pass]))
      body.appendChild(el("div", { style:"height:10px" }))

      body.appendChild(el("div", { class:"row" }, [
        el("button", {
          class:"btn",
          onclick: function() {
            signIn(email.value.trim(), pass.value).then(function() {
              toast("ok", tx("done"))
              showModal("modalUser", false)
              renderCurrent(true)
            }).catch(function(e) {
              toast("bad", e.message || String(e))
            })
          }
        }, [tx("signIn")]),
        el("button", {
          class:"btn secondary",
          onclick: function() {
            signUp(email.value.trim(), pass.value).then(function() {
              toast("ok", state.lang==="en" ? "Check your email if confirmation is enabled" : "ÿ±ÿßÿ¨ÿπ ÿ®ÿ±ŸäÿØŸÉ ŸÑŸà ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖŸÅÿπŸÑ")
              showModal("modalUser", false)
              renderCurrent(true)
            }).catch(function(e) {
              toast("bad", e.message || String(e))
            })
          }
        }, [tx("signUp")])
      ]))
    }

    function renderCurrent() {
      if (!state.sb) return
      if (state.tab === "home") return renderHome()
      if (state.tab === "invoices") return renderInvoices()
      if (state.tab === "documents") return renderDocuments()
      if (state.tab === "support") return renderSupport()
      if (state.tab === "meetings") return renderMeetings()
      return renderHome()
    }

    function wireUI() {
      document.getElementById("btnLang").addEventListener("click", function() {
        setLang(state.lang === "en" ? "ar" : "en")
      })
      document.getElementById("btnSettings").addEventListener("click", function() {
        renderSettings()
        showModal("modalSettings", true)
      })
      document.getElementById("btnUser").addEventListener("click", function() {
        renderUserModal()
        showModal("modalUser", true)
      })
      document.getElementById("closeUser").addEventListener("click", function() { showModal("modalUser", false) })
      document.getElementById("closeSettings").addEventListener("click", function() { showModal("modalSettings", false) })
      document.getElementById("modalUser").addEventListener("click", function(e) { if (e.target && e.target.id === "modalUser") showModal("modalUser", false) })
      document.getElementById("modalSettings").addEventListener("click", function(e) { if (e.target && e.target.id === "modalSettings") showModal("modalSettings", false) })
    }

    async function boot() {
      try {
        setLang(state.lang)
        wireUI()
        renderNav()

        await ensureSupabaseReady()
        buildClient()
        await loadSession()

        state.sb.auth.onAuthStateChange(function() {
          loadSession().then(function() { renderCurrent() })
        })

        renderCurrent()

      } catch (e) {
        document.getElementById("loadingTitle").textContent = state.lang==="en" ? "App failed to start" : "ŸÅÿ¥ŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"
        document.getElementById("loadingSub").textContent = e.message || String(e)
        document.getElementById("loadingTag").textContent = tx("failed")
        toast("bad", e.message || String(e))
      }
    }

    boot()
  })()
</script>
</body>
</html>
