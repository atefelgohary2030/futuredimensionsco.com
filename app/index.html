<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#b68c38">
  <title>Future Dimensions</title>
  <link rel="manifest" href="/app/manifest.webmanifest">
  <link rel="icon" href="/app/logo.png">
  <link rel="apple-touch-icon" href="/app/apple-touch-icon.png">
  <style>
    :root{
      --bg1:#0b0f14;
      --bg2:#061b33;
      --panel:rgba(16,20,26,0.78);
      --panel2:rgba(10,13,18,0.72);
      --border:rgba(255,255,255,0.08);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.66);
      --gold:#b68c38;
      --gold2:#f7e69b;
      --shadow:0 16px 40px rgba(0,0,0,0.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background: radial-gradient(1100px 520px at 50% -140px, rgba(182,140,56,0.22), transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .app{min-height:100vh; display:flex; flex-direction:column}
    .topbar{padding:12px 14px 8px; display:flex; justify-content:center}
    .topbar-inner{
      width:min(980px, calc(100vw - 20px));
      background:var(--panel);
      border:1px solid rgba(182,140,56,0.20);
      box-shadow:var(--shadow);
      border-radius:22px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(10px);
    }
    .logo{display:flex; align-items:center; gap:10px; min-width:0}
    .mark{
      width:38px; height:38px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(182,140,56,0.25), rgba(247,230,155,0.10));
      border:1px solid rgba(182,140,56,0.35);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .mark img{width:34px; height:34px; border-radius:10px; display:block}
    #logoFallbackText{display:none; font-weight:900; color:var(--gold2); letter-spacing:0.5px}
    .brand{font-weight:900; font-size:15px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subbrand{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .controls{display:flex; align-items:center; gap:8px; flex:0 0 auto}
    .chip{
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.22);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      font-size:12px;
      color:var(--text);
    }
    .chip.active{
      border-color:rgba(182,140,56,0.55);
      background:linear-gradient(135deg, rgba(182,140,56,0.26), rgba(247,230,155,0.10));
    }
    .iconbtn{
      width:34px; height:34px;
      display:flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.22);
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .badge-dot{
      position:absolute;
      top:5px; right:6px;
      min-width:16px; height:16px;
      border-radius:999px;
      background:rgba(182,140,56,0.95);
      color:#111;
      font-weight:900;
      font-size:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(0,0,0,0.25);
    }
    .content{
      width:min(980px, calc(100vw - 20px));
      margin:10px auto 86px;
      padding:2px 2px 20px;
      min-height: calc(100vh - 170px);
    }
    .card{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding:14px;
    }
    .grid{display:grid; gap:10px}
    @media (min-width:720px){ .grid.cols2{grid-template-columns:1fr 1fr} }
    .title{font-weight:950; font-size:16px}
    .muted{color:var(--muted); font-size:13px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(182,140,56,0.40);
      background:linear-gradient(135deg, rgba(182,140,56,0.28), rgba(247,230,155,0.08));
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary{
      border-color:rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.22);
      font-weight:800;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .list{margin-top:10px}
    .item{
      display:flex; gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.16);
      margin-bottom:10px;
    }
    .ico{width:38px; height:38px; border-radius:14px; display:flex; align-items:center; justify-content:center;
      background:rgba(182,140,56,0.14); border:1px solid rgba(182,140,56,0.22)
    }
    .it-main{min-width:0; flex:1}
    .it-title{margin:0; font-weight:950}
    .it-sub{margin:4px 0 0; color:var(--muted); font-size:13px}
    .bottomnav{
      position:fixed;
      left:0; right:0; bottom:0;
      display:flex;
      justify-content:center;
      padding:10px 10px 14px;
      pointer-events:none;
    }
    .bottomnav-inner{
      width:min(980px, calc(100vw - 20px));
      background:rgba(0,0,0,0.32);
      border:1px solid rgba(182,140,56,0.22);
      box-shadow:var(--shadow);
      border-radius:22px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      pointer-events:auto;
      backdrop-filter: blur(10px);
    }
    .navbtn{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.18);
      padding:10px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      user-select:none;
      min-width:0;
    }
    .navbtn.active{
      border-color:rgba(182,140,56,0.55);
      background:linear-gradient(135deg, rgba(182,140,56,0.26), rgba(247,230,155,0.10));
    }
    .navlbl{font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:100px;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.12);
      padding:10px 12px;
      border-radius:14px;
      display:none;
      box-shadow:var(--shadow);
      max-width: min(680px, calc(100vw - 20px));
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .modal-wrap{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.45);
      padding:16px;
      z-index:99;
    }
    .modal{
      width:min(560px, calc(100vw - 20px));
      background:rgba(10,12,16,0.86);
      border:1px solid rgba(182,140,56,0.25);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.10)}
    .modal-title{font-weight:950}
    .closex{cursor:pointer; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.22)}
    .modal-body{padding:14px}
    .modal-actions{padding:12px 14px; border-top:1px solid rgba(255,255,255,0.10); display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    input,select,textarea{
      width:100%;
      background:rgba(0,0,0,0.25);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-weight:700;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .hr{height:1px; background:rgba(255,255,255,0.10); margin:12px 0}
    [dir="rtl"] .row{justify-content:flex-start}
  
    .warn{color:rgba(255,180,170,0.95); font-weight:800}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="logo">
          <div class="mark" id="mark">
            <img id="brandLogo" alt="Future Dimensions logo" src="/app/logo.png">
            <span aria-hidden="true" id="logoFallbackText">FD</span>
          </div>
          <div style="min-width:0">
            <div class="brand" id="brand">Future Dimensions</div>
            <div class="subbrand" id="subbrand">Consulting &amp; Business Solutions</div>
          </div>
        </div>

        <div class="controls">
          <div class="chip active" id="enBtn">EN</div>
          <div class="chip" id="arBtn">Ø¹Ø±Ø¨ÙŠ</div>
          <div class="iconbtn" id="notifBtn" title="Notifications">
            ğŸ””
            <div class="badge-dot" id="notifCount" style="display:none">0</div>
          </div>
          <div class="iconbtn" id="profileBtn" title="Profile">ğŸ‘¤</div>
        </div>
      </div>
    </div>

    <div class="content" id="content"></div>
    <div class="bottomnav" id="bottomnav"></div>
    <div class="toast" id="toast"></div>

    <div class="modal-wrap" id="modalWrap">
      <div class="modal">
        <div class="modal-head">
          <div class="modal-title" id="modalTitle">Details</div>
          <div class="closex" id="modalClose">âœ•</div>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const img = document.getElementById("brandLogo")
      img.onerror = () => {
        img.style.display = "none"
        const t = document.getElementById("logoFallbackText")
        if (t) t.style.display = "block"
      }
    })()
  </script>

  <script>
    (function () {
      const cdns = [
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js",
        "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"
      ]

      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script")
          s.src = url
          s.async = true
          s.onload = () => resolve(url)
          s.onerror = () => reject(new Error("Failed to load " + url))
          document.head.appendChild(s)
        })
      }

      async function ensureSupabase() {
        if (window.supabase && typeof window.supabase.createClient === "function") return
        for (const url of cdns) {
          try {
            await loadScript(url)
            if (window.supabase && typeof window.supabase.createClient === "function") return
          } catch (e) {}
        }
        throw new Error("Supabase library did not load")
      }

      window.__ensureSupabase = ensureSupabase
    })()
  </script>

  <script>
    (async function () {
      const SUPABASE_URL = "https://mifottrhqimqzojiyytq.supabase.co"
      const SUPABASE_ANON_KEY = "sb_publishable_nJKPr9Lk-SppxXMAwLG79g_cz2d5rir"

      const state = {
        lang: "en",
        page: "home",
        authed: false,
        user: null,
        sb: null,
        notifs: []
      }

      const strings = {
        en: {
          home_title: "Client Portal",
          home_desc: "Sign in to view projects, invoices, documents, support tickets, and meeting requests.",
          sign_in: "Sign in",
          sign_up: "Create account",
          sign_out: "Sign out",
          dashboard: "Dashboard",
          invoices: "Invoices",
          documents: "Documents",
          support: "Support",
          meetings: "Meetings",
          profile: "Profile",
          email: "Email",
          password: "Password",
          loading: "Loading",
          ok: "OK",
          close: "Close",
          need_setup: "This feature needs Supabase tables to be created. Next step: we will create them together.",
          file_attached: "File attached",
          refresh: "Refresh",
          no_invoices: "No invoices yet.",
          invoice: "Invoice",
          amount: "Amount",
          status: "Status",
          created_at: "Created",
          no_file: "No file",
          error: "Error"
        },
        ar: {
          home_title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„",
          home_desc: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯Ø¹Ù… ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹.",
          sign_in: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„",
          sign_up: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
          sign_out: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
          dashboard: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
          invoices: "Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
          documents: "Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª",
          support: "Ø§Ù„Ø¯Ø¹Ù…",
          meetings: "Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª",
          profile: "Ø§Ù„Ø­Ø³Ø§Ø¨",
          email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
          password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
          loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
          ok: "Ù…ÙˆØ§ÙÙ‚",
          close: "Ø¥ØºÙ„Ø§Ù‚",
          need_setup: "Ø§Ù„Ù…ÙŠØ²Ø© ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Supabase. Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù‡Ù†Ø¬Ù‡Ø²Ù‡Ø§ Ø³ÙˆØ§.",
          file_attached: "ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø±ÙÙ‚",
          download: "ØªØ­Ù…ÙŠÙ„",
          download_failed: "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
          opening_file: "Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù…Ù„Ù",
          refresh: "ØªØ­Ø¯ÙŠØ«",
          no_invoices: "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.",
          invoice: "ÙØ§ØªÙˆØ±Ø©",
          amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
          status: "Ø§Ù„Ø­Ø§Ù„Ø©",
          created_at: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
          no_file: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù",
          error: "Ø®Ø·Ø£"
        }
      }

      function tr(k) {
        return (strings[state.lang] && strings[state.lang][k]) || k
      }

      function el(id) {
        return document.getElementById(id)
      }

      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[c]))
      }


      function toast(msg) {
        const t = el("toast")
        if (!t) return
        t.textContent = msg
        t.style.display = "block"
        clearTimeout(toast._t)
        toast._t = setTimeout(() => (t.style.display = "none"), 2400)
      }

      function setLang(l) {
        state.lang = l
        localStorage.setItem("fd_lang", l)
        document.documentElement.lang = l
        document.documentElement.dir = l === "ar" ? "rtl" : "ltr"
        el("enBtn").classList.toggle("active", l === "en")
        el("arBtn").classList.toggle("active", l === "ar")
        render()
      }

      function openModal(title, bodyHTML, actions) {
        el("modalTitle").textContent = title
        el("modalBody").innerHTML = bodyHTML
        const a = el("modalActions")
        a.innerHTML = ""
        actions.forEach((x) => {
          const b = document.createElement("button")
          b.className = "btn" + (x.secondary ? " secondary" : "")
          b.textContent = x.label
          b.onclick = x.onClick
          a.appendChild(b)
        })
        el("modalWrap").style.display = "flex"
      }

      function closeModal() {
        el("modalWrap").style.display = "none"
        el("modalBody").innerHTML = ""
      }

      function showFatal(title, details) {
        el("content").innerHTML = `
          <div class="card">
            <div class="title">${title}</div>
            <div class="muted" style="margin-top:6px">${details}</div>
            <div class="row" style="margin-top:12px">
              <div class="btn secondary" id="reloadBtn">${state.lang === "ar" ? "Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„" : "Reload"}</div>
            </div>
          </div>
        `
        const r = el("reloadBtn")
        if (r) r.onclick = () => location.reload()
      }

      async 

      async function downloadInvoiceFile(storagePath) {
        try {
          if (!storagePath) {
            toast(tr("no_file"))
            return
          }
          toast(tr("opening_file"))
          const bucket = "Invoices"
          let objectPath = storagePath
          if (objectPath.toLowerCase().startsWith("invoices/")) objectPath = objectPath.slice(9)
          const { data, error } = await state.sb.storage.from(bucket).createSignedUrl(objectPath, 60 * 10)
          if (error) throw error
          const url = data && (data.signedUrl || data.signedURL)
          if (!url) throw new Error("No signed URL returned")
          window.open(url, "_blank", "noopener")
        } catch (e) {
          console.error(e)
          alert(tr("download_failed") + (e && e.message ? ": " + e.message : ""))
        }
      }
function clearCachesAndUnregister() {
        try {
          if ("caches" in window) {
            const keys = await caches.keys()
            await Promise.all(keys.map((k) => caches.delete(k)))
          }
        } catch (e) {}
        try {
          if ("serviceWorker" in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations()
            await Promise.all(regs.map((r) => r.unregister()))
          }
        } catch (e) {}
      }

      function renderBottomNav() {
        const host = el("bottomnav")
        if (!host) return

        if (!state.authed) {
          host.innerHTML = ""
          return
        }

        const items = [
          { id: "dashboard", label: tr("dashboard"), icon: "ğŸ " },
          { id: "invoices", label: tr("invoices"), icon: "ğŸ§¾" },
          { id: "documents", label: tr("documents"), icon: "ğŸ“" },
          { id: "support", label: tr("support"), icon: "ğŸ«" },
          { id: "meetings", label: tr("meetings"), icon: "ğŸ“…" }
        ]

        host.innerHTML = `
          <div class="bottomnav-inner">
            ${items.map((it) => `
              <div class="navbtn ${state.page === it.id ? "active" : ""}" data-nav="${it.id}">
                <span>${it.icon}</span>
                <span class="navlbl">${it.label}</span>
              </div>
            `).join("")}
          </div>
        `

        host.querySelectorAll("[data-nav]").forEach((b) => {
          b.onclick = () => {
            state.page = b.getAttribute("data-nav")
            render()
          }
        })
      }

      function renderHome() {
        el("content").innerHTML = `
          <div class="grid cols2">
            <div class="card">
              <div class="title">${tr("home_title")}</div>
              <div class="muted" style="margin-top:8px">${tr("home_desc")}</div>
              <div class="row" style="margin-top:12px">
                <div class="btn" id="btnSignIn">${tr("sign_in")}</div>
                <div class="btn secondary" id="btnSignUp">${tr("sign_up")}</div>
              </div>
            </div>

            <div class="card">
              <div class="title">${state.lang === "ar" ? "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©" : "Notes"}</div>
              <div class="muted" style="margin-top:8px">
                ${state.lang === "ar"
                  ? "Ù„Ùˆ Ø´Ø§ÙŠÙ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù‚ÙØ© Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© ÙØ§Ø¶ÙŠØ©ØŒ Ù‡Ù†Ø·Ù„Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…Ù† Console ÙÙŠ Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø©."
                  : "If you see a blank screen, we will grab Console errors in one step."}
              </div>
            </div>
          </div>
        `

        el("btnSignIn").onclick = () => openAuth("in")
        el("btnSignUp").onclick = () => openAuth("up")
      }

      function renderDashboard() {
        el("content").innerHTML = `
          <div class="card">
            <div class="title">${tr("dashboard")}</div>
            <div class="muted" style="margin-top:6px">${state.user ? state.user.email : ""}</div>
            <div class="hr"></div>
            <div class="muted">${tr("need_setup")}</div>
          </div>
        `
      }

      
      function fmtDate(ts) {
        if (!ts) return ""
        try {
          const d = new Date(ts)
          return d.toLocaleDateString(state.lang === "ar" ? "ar-EG" : "en-US", { year: "numeric", month: "short", day: "2-digit" })
        } catch (e) {
          return ""
        }
      }

      function renderInvoices() {
        el("content").innerHTML = `
          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:center">
              <div class="title">${tr("invoices")}</div>
              <button class="btn" id="btnInvRefresh">${tr("refresh")}</button>
            </div>
            <div class="hr"></div>
            <div id="invList" class="muted">${tr("loading")}...</div>
          </div>
        `
        el("btnInvRefresh").onclick = () => loadInvoices()
        loadInvoices()
      }

      async function loadInvoices() {
        const host = el("invList")
        host.innerHTML = `${tr("loading")}...`
        try {
          const { data, error } = await state.sb
            .from("invoices")
            .select("id, amount, status, storage_path, created_at")
            .order("created_at", { ascending: false })

          if (error) {
            host.innerHTML = `<div class="warn">${tr("error")}: ${escapeHtml(error.message || error)}</div>`
            return
          }

          if (!data || data.length === 0) {
            host.innerHTML = `<div class="muted">${tr("no_invoices")}</div>`
            return
          }

          host.innerHTML = `
            <div class="list">
              ${data.map((it) => `
                <div class="item">
                  <div class="ico">ğŸ§¾</div>
                  <div class="it-main">
                    <div class="it-title">${tr("invoice")} #${(it.id || "").slice(0, 8)}</div>
                    <div class="it-sub">
                      <span>${tr("amount")}: <b>${it.amount ?? "-"}</b></span>
                       â€¢ 
                      <span>${tr("status")}: <b>${escapeHtml(it.status || "-")}</b></span>
                       â€¢ 
                      <span>${tr("created_at")}: <b>${fmtDate(it.created_at)}</b></span>
                      ${it.storage_path ? " â€¢ <b>" + tr("file_attached") + "</b>" : ""}
                    </div>
                  </div>
                  <div class="iconbtn dlbtn" title="${tr('download')}" data-path="${it.storage_path || ''}" style="${it.storage_path ? '' : 'opacity:.35;pointer-events:none;'}">ğŸ“„</div>
                </div>
              `).join("")}
            </div>
          `

          host.querySelectorAll(".dlbtn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const p = decodeURIComponent(btn.getAttribute("data-path") || "")
              await downloadInvoiceFile(p)
            })
          })
        } catch (e) {
          host.innerHTML = `<div class="warn">${tr("error")}</div>`
        }
      }

function renderStubPage(title) {
        el("content").innerHTML = `
          <div class="card">
            <div class="title">${title}</div>
            <div class="muted" style="margin-top:8px">${tr("need_setup")}</div>
          </div>
        `
      }

      function render() {
        renderBottomNav()

        if (!state.authed) {
          state.page = "home"
          renderHome()
          return
        }

        if (state.page === "dashboard") renderDashboard()
        else if (state.page === "invoices") renderInvoices()
        else if (state.page === "documents") renderStubPage(tr("documents"))
        else if (state.page === "support") renderStubPage(tr("support"))
        else if (state.page === "meetings") renderStubPage(tr("meetings"))
        else renderDashboard()
      }

      function openAuth(mode) {
        const isUp = mode === "up"
        openModal(
          isUp ? tr("sign_up") : tr("sign_in"),
          `
            <label>${tr("email")}</label>
            <input id="authEmail" type="email" placeholder="name@example.com">
            <label>${tr("password")}</label>
            <input id="authPass" type="password" placeholder="********">
          `,
          [
            {
              label: isUp ? tr("sign_up") : tr("sign_in"),
              onClick: async () => {
                const email = (el("authEmail").value || "").trim()
                const password = (el("authPass").value || "").trim()
                if (!email || !password) return toast(tr("ok"))

                try {
                  if (isUp) {
                    const res = await state.sb.auth.signUp({ email, password })
                    if (res.error) return toast(res.error.message)
                    toast(tr("ok"))
                  } else {
                    const res = await state.sb.auth.signInWithPassword({ email, password })
                    if (res.error) return toast(res.error.message)
                    toast(tr("ok"))
                  }
                  closeModal()
                } catch (e) {
                  toast("Error")
                }
              }
            },
            { label: tr("close"), secondary: true, onClick: closeModal }
          ]
        )
      }

      async function boot() {
        const saved = localStorage.getItem("fd_lang")
        if (saved === "ar" || saved === "en") state.lang = saved
        setLang(state.lang)

        const url = new URL(location.href)
        if (url.searchParams.get("reset") === "1") {
          await clearCachesAndUnregister()
          url.searchParams.delete("reset")
          location.replace(url.toString())
          return
        }

        try {
          await window.__ensureSupabase()
        } catch (e) {
          showFatal(state.lang === "ar" ? "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„" : "Load problem",
            state.lang === "ar"
              ? "Ù…ÙƒØªØ¨Ø© Supabase Ù„Ù… ØªØ­Ù…Ù„. Ø¬Ø±Ø¨ Ø´Ø¨ÙƒØ© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø§ÙØªØ­ Console ÙˆØ§Ø¨Ø¹ØªÙ‡ÙˆÙ„ÙŠ."
              : "Supabase library did not load. Try another network or send Console errors.")
          return
        }

        try {
          state.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        } catch (e) {
          showFatal("Error", "Supabase init failed")
          return
        }

        const session = await state.sb.auth.getSession()
        state.authed = !!(session && session.data && session.data.session)
        state.user = session && session.data && session.data.session ? session.data.session.user : null

        state.sb.auth.onAuthStateChange((event, s) => {
          state.authed = !!s
          state.user = s ? s.user : null
          if (!state.authed) state.page = "home"
          if (state.authed && state.page === "home") state.page = "dashboard"
          render()
        })

        if (state.authed) state.page = "dashboard"
        render()
      }

      function bindTopbar() {
        el("enBtn").onclick = () => setLang("en")
        el("arBtn").onclick = () => setLang("ar")
        el("modalClose").onclick = closeModal
        el("modalWrap").onclick = (e) => { if (e.target === el("modalWrap")) closeModal() }

        el("profileBtn").onclick = async () => {
          if (!state.authed) return openAuth("in")
          openModal(
            tr("profile"),
            `<div class="muted">${state.user ? state.user.email : ""}</div>`,
            [
              {
                label: tr("sign_out"),
                onClick: async () => {
                  try { await state.sb.auth.signOut() } catch (e) {}
                  closeModal()
                }
              },
              { label: tr("close"), secondary: true, onClick: closeModal }
            ]
          )
        }

        el("notifBtn").onclick = () => toast(tr("ok"))
      }

      bindTopbar()
      boot()
    })()
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/app/sw.js", { scope: "/app/" }).catch(() => {})
      })
    }
  </script>
</body>
</html>
